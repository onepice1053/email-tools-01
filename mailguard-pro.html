<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Email Header Cleaner Pro | Clean & Mask Email Headers</title>
  <meta name="description" content="Professional email header cleaning tool. Mask domains, filter headers, and customize email source with ease.">

  <style>
    /* --- Reset & Basics --- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #111827; 
      transition: background 0.3s, color 0.3s;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }
    body.light-theme {
      background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
      color: #111827;
    }
    body.midnight-theme {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    }
    body.forest-theme {
      background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
    }
    body.sunset-theme {
      background: linear-gradient(135deg, #451a03 0%, #78350f 100%);
    }
    body.purple-theme {
      background: linear-gradient(135deg, #3b0764 0%, #581c87 100%);
    }
    body.ocean-theme {
      background: linear-gradient(135deg, #042f2e 0%, #134e4a 100%);
    }
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: url('https://lh7-rt.googleusercontent.com/docsz/AD_4nXdGJFYq-3s0kCkcvChsiaOjIIeoZ9-9EV6R0zDTIEUDlKRyUaOag4Uk90oPOzG7Hbpu7_gaO89GPniCDYj2QA7VN1LGcJyU2T4a8tn_FaBDWs02iRate_fZzLDa-djZ3yvNdQCI0g?key=kPCYD9-hSyEMaloJ2u6zGw');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0.15;
      z-index: 0;
      pointer-events: none;
    }
    body.dark-mode { 
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #f3f4f6; 
    }
    body.dark-mode::before {
      opacity: 0.25;
    }
    body > * {
      position: relative;
      z-index: 1;
    }
    h1, h2 { color: #1f2937; transition: color 0.3s; }
    body.dark-mode h1, body.dark-mode h2 { color: #f3f4f6; }

    .container { 
      width: 100%;
      height: calc(100vh - 160px);
      margin: 0;
      padding: 0.75rem; 
      display: flex; 
      gap: 0.75rem;
    }
    header { 
      text-align: center; 
      padding: 1.5rem 1rem 1rem;
      position: relative; 
      color: white;
    }
    header h1 {
      color: white;
      font-size: 2rem;
      font-weight: 700;
      text-shadow: 0 2px 10px rgba(0,0,0,0.2);
      margin-bottom: 0.25rem;
    }
    header p {
      color: rgba(255,255,255,0.9);
      font-size: 1rem;
    }

    .card { 
      background: #ffffff; 
      border-radius: 1rem; 
      padding: 1.25rem; 
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
      display: flex; 
      flex-direction: column; 
      transition: all 0.3s;
      flex: 1;
      height: 100%;
      overflow: hidden;
    }
    body.dark-mode .card { 
      background: #1f2937; 
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.4), 0 10px 10px -5px rgba(0,0,0,0.3);
    }
    .card h2 { margin-bottom: 0.75rem; font-size: 1.2rem; font-weight: 600; }

    textarea, #output { 
      width: 100%; 
      flex: 1; 
      padding: 1rem; 
      border-radius: 0.5rem; 
      border: 2px solid #e5e7eb;
      font-family: 'Courier New', Courier, monospace; 
      font-size: 0.9rem; 
      background: #f9fafb; 
      color: #111827; 
      overflow: auto; 
      resize: none;
      transition: all 0.3s;
      line-height: 1.5;
    }
    textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    body.dark-mode textarea, body.dark-mode #output { 
      background: #111827; 
      color: #f3f4f6; 
      border-color: #374151;
    }
    body.dark-mode textarea:focus {
      border-color: #60a5fa;
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
    }
    #output { 
      background: #f9fafb;
      border: 2px dashed #e5e7eb;
    }
    body.dark-mode #output {
      background: #111827;
      border-color: #374151;
    }
    #output pre { white-space: pre-wrap; word-break: break-word; margin: 0; }
    #output.has-content { border-style: solid; border-color: #10b981; }
    body.dark-mode #output.has-content { border-color: #059669; }

    /* Syntax highlighting for email headers */
    .email-header {
      color: #3b82f6;
      font-weight: 600;
    }
    body.dark-mode .email-header {
      color: #60a5fa;
    }
    .email-header-name {
      color: #8b5cf6;
      font-weight: 700;
    }
    body.dark-mode .email-header-name {
      color: #a78bfa;
    }

    .btn { 
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.625rem 1rem; 
      border-radius: 0.5rem; 
      font-weight: 600; 
      text-decoration: none; 
      cursor: pointer; 
      transition: all 0.2s; 
      border: none;
      font-size: 0.875rem;
      white-space: nowrap;
    }
    .btn-blue { background-color: #3b82f6; color: #ffffff; }
    .btn-blue:hover { background-color: #2563eb; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
    .btn-blue:active { transform: translateY(0); }
    .btn-green { background-color: #10b981; color: #ffffff; }
    .btn-green:hover { background-color: #059669; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
    .btn-gray { background-color: #6b7280; color: #ffffff; }
    .btn-gray:hover { background-color: #4b5563; transform: translateY(-1px); }
    .btn-red { background-color: #ef4444; color: #ffffff; }
    .btn-red:hover { background-color: #dc2626; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4); }
    .btn-icon { padding: 0.625rem; }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .header-btns { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .btn-group { 
      display: flex; 
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .settings-btn-container { 
      position: absolute; 
      top: 1.5rem; 
      right: 1.5rem; 
      display: flex; 
      gap: 0.5rem;
      z-index: 10;
    }

    .theme-toggle { 
      width: 2.5rem; 
      height: 2.5rem; 
      border-radius: 0.75rem; 
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      color: white; 
      border: 1px solid rgba(255, 255, 255, 0.3);
      cursor: pointer; 
      font-size: 1.2rem; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      transition: all 0.3s;
    }
    .theme-toggle:hover { 
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .stats-bar {
      display: flex;
      gap: 1rem;
      padding: 0.625rem 0.75rem;
      background: #f3f4f6;
      border-radius: 0.5rem;
      margin-top: 0.75rem;
      font-size: 0.8rem;
      flex-wrap: wrap;
      flex-shrink: 0;
    }
    body.dark-mode .stats-bar {
      background: #374151;
    }
    .stat-item {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      color: #6b7280;
    }
    body.dark-mode .stat-item {
      color: #9ca3af;
    }
    .stat-value {
      font-weight: 700;
      color: #3b82f6;
    }
    body.dark-mode .stat-value {
      color: #60a5fa;
    }

    .modal-overlay { 
      display: none; 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0; 
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 1000; 
      align-items: center; 
      justify-content: center;
      animation: fadeIn 0.2s ease-in-out;
      padding: 1rem;
    }
    .modal-overlay.active { display: flex; }
    .modal { 
      background: #1f2937; 
      border-radius: 1rem; 
      padding: 2rem; 
      max-width: 600px; 
      width: 100%; 
      max-height: 90vh; 
      overflow-y: auto; 
      color: #f3f4f6; 
      transition: background 0.3s;
      animation: slideUp 0.3s ease-out;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    body.dark-mode .modal { background: #374151; }
    .modal-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 1.5rem;
    }
    .modal-header h2 { 
      color: #f3f4f6; 
      font-size: 1.5rem;
    }
    .modal-close { 
      background: transparent; 
      border: none; 
      color: #9ca3af; 
      font-size: 1.75rem; 
      cursor: pointer; 
      padding: 0; 
      width: 2rem; 
      height: 2rem; 
      display: flex; 
      align-items: center; 
      justify-content: center;
      border-radius: 0.375rem;
      transition: all 0.2s;
    }
    .modal-close:hover { 
      color: #f3f4f6;
      background: rgba(255, 255, 255, 0.1);
    }
    .modal-description { 
      color: #9ca3af; 
      margin-bottom: 2rem; 
      font-size: 0.95rem;
    }

    .settings-group { 
      background: #374151; 
      border-radius: 0.75rem; 
      padding: 1.5rem; 
      transition: background 0.3s;
      margin-bottom: 1.5rem;
    }
    body.dark-mode .settings-group { background: #1f2937; }
    .settings-group h3 { 
      color: #f3f4f6; 
      font-size: 1.1rem; 
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .setting-item { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 1rem 0; 
      border-bottom: 1px solid #4b5563;
    }
    .setting-item:last-child { border-bottom: none; }
    .setting-info { flex: 1; }
    .setting-label { 
      color: #f3f4f6; 
      font-weight: 600; 
      display: block; 
      margin-bottom: 0.25rem;
    }
    .setting-description { 
      color: #9ca3af; 
      font-size: 0.85rem;
      line-height: 1.4;
    }

    .toggle-switch { 
      position: relative; 
      width: 3rem; 
      height: 1.5rem; 
      margin-left: 1rem;
      flex-shrink: 0;
    }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { 
      position: absolute; 
      cursor: pointer; 
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0; 
      background-color: #4b5563; 
      border-radius: 1.5rem; 
      transition: 0.3s;
    }
    .toggle-slider:before { 
      position: absolute; 
      content: ""; 
      height: 1.25rem; 
      width: 1.25rem; 
      left: 0.125rem; 
      bottom: 0.125rem; 
      background-color: white; 
      border-radius: 50%; 
      transition: 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .toggle-switch input:checked + .toggle-slider { background-color: #3b82f6; }
    .toggle-switch input:checked + .toggle-slider:before { transform: translateX(1.5rem); }

    /* Checkbox List */
    .checkbox-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      max-height: 350px;
      overflow-y: auto;
      padding: 0.5rem 0;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.625rem;
      background: #111827;
      border-radius: 0.375rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .checkbox-item:hover {
      background: #4b5563;
    }
    .checkbox-item input[type="checkbox"] {
      cursor: pointer;
      width: 1.125rem;
      height: 1.125rem;
      accent-color: #3b82f6;
    }
    .checkbox-item label {
      flex: 1;
      cursor: pointer;
      color: #f3f4f6;
      font-weight: 500;
      margin: 0;
    }

    input[type="text"], textarea.settings-textarea {
      width: 100%; 
      padding: 0.625rem; 
      border-radius: 0.5rem; 
      border: 1px solid #4b5563; 
      background: #1f2937; 
      color: #f3f4f6; 
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    body.dark-mode input[type="text"], body.dark-mode textarea.settings-textarea {
      background: #111827;
      border-color: #374151;
    }
    input[type="text"]:focus, textarea.settings-textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: #10b981;
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 0.75rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      display: none;
      align-items: center;
      gap: 0.75rem;
      z-index: 2000;
      animation: slideInRight 0.3s ease-out;
      font-weight: 500;
      max-width: 90vw;
    }
    .toast.show { display: flex; }
    .toast.error { background: #ef4444; }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(100px); }
      to { opacity: 1; transform: translateX(0); }
    }

    footer {
      text-align: center;
      padding: 1rem;
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.85rem;
    }
    footer strong {
      color: white;
      font-weight: 700;
    }

    /* New styles for replacement fields */
    .replacement-fields {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .replacement-field {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .replacement-field label {
      font-weight: 600;
      color: #f3f4f6;
      font-size: 0.9rem;
    }
    .replacement-field input {
      width: 100%;
      padding: 0.625rem;
      border-radius: 0.5rem;
      border: 1px solid #4b5563;
      background: #1f2937;
      color: #f3f4f6;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    body.dark-mode .replacement-field input {
      background: #111827;
      border-color: #374151;
    }
    .replacement-field input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .replacement-field .field-description {
      font-size: 0.75rem;
      color: #9ca3af;
      line-height: 1.4;
    }

    @media (max-width: 1024px) { 
      .container { 
        flex-direction: column;
        height: auto;
        min-height: calc(100vh - 180px);
      }
      .card { min-height: 400px; }
      .settings-btn-container { top: 1rem; right: 1rem; }
      header h1 { font-size: 1.75rem; }
      .btn-group { width: 100%; }
      .btn-group .btn { flex: 1; }
      .replacement-fields {
        grid-template-columns: 1fr;
      }
    }
    .theme-option:hover {
      border-color: #3b82f6 !important;
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
    }

    .theme-option.active {
      border-color: #10b981 !important;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
    }

    .insertion-position-option input[type="radio"]:checked ~ div {
      color: #60a5fa !important;
    }

    .insertion-position-option:hover {
      background: #1e293b !important;
    }

    @media (max-width: 640px) {
      header { padding: 1rem 1rem 0.75rem; }
      header h1 { font-size: 1.5rem; }
      header p { font-size: 0.875rem; }
      .card { padding: 1rem; min-height: 350px; }
      textarea, #output { font-size: 0.8rem; padding: 0.75rem; }
      .settings-btn-container { gap: 0.25rem; }
      .theme-toggle, .btn-icon { width: 2.25rem; height: 2.25rem; font-size: 1rem; }
      .stats-bar { font-size: 0.75rem; gap: 0.75rem; }
      .modal { padding: 1.5rem; }
      .theme-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)) !important; }
    }

    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 5px;
    }
    body.dark-mode ::-webkit-scrollbar-track {
      background: #374151;
    }
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 5px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    body.dark-mode ::-webkit-scrollbar-thumb {
      background: #4b5563;
    }
    body.dark-mode ::-webkit-scrollbar-thumb:hover {
      background: #6b7280;
    }
  </style>
</head>
<body>

  <header>
    <h1>MailGuard Pro</h1>
    <p>Clean, mask, and customize email headers with ease</p>
    <div class="settings-btn-container">
      <button id="themeToggle" class="theme-toggle" title="Choose Theme">üé®</button>
      <button id="projectManagerBtn" class="btn btn-gray btn-icon" title="Project Manager">üìÅ</button>
      <button id="headerRemovalBtn" class="btn btn-gray btn-icon" title="Custom Header Removal">üö´</button>
      <button id="replacementHeadersBtn" class="btn btn-gray btn-icon" title="Replacement Headers">üîÑ</button>
      <button id="smartInsertBtn" class="btn btn-gray btn-icon" title="Smart Insert">‚ûï</button>
    </div>
  </header>

  <div class="container">
    <section class="card">
      <div class="header-btns">
        <h2>üì• Paste Raw Email Source</h2>
        <div class="btn-group">
          <button id="cleanBtn" class="btn btn-blue">üßπ Clean</button>
          <button id="batchUploadBtn" class="btn btn-green">üì¶ Batch Upload</button>
          <button id="clearInputBtn" class="btn btn-red">üóëÔ∏è Clear</button>
        </div>
      </div>
      <textarea id="input" placeholder="Paste full email source (headers + body) here..." spellcheck="false"></textarea>
      <div class="stats-bar">
        <div class="stat-item">
          <span>üìÑ Lines:</span>
          <span class="stat-value" id="inputLines">0</span>
        </div>
        <div class="stat-item">
          <span>üí¨ Characters:</span>
          <span class="stat-value" id="inputChars">0</span>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="header-btns">
        <h2>‚úÖ Cleaned Source</h2>
        <div class="btn-group">
          <button id="copyBtn" class="btn btn-green" disabled>üìã Copy</button>
          <button id="downloadBtn" class="btn btn-gray" disabled>üíæ Download</button>
          <button id="clearOutputBtn" class="btn btn-red">üóëÔ∏è Clear</button>
        </div>
      </div>
      <div id="output"><pre id="outpre">[No output yet] Paste email source and click Clean to get started.</pre></div>
      <div class="stats-bar">
        <div class="stat-item">
          <span>üìÑ Lines:</span>
          <span class="stat-value" id="outputLines">0</span>
        </div>
        <div class="stat-item">
          <span>üí¨ Characters:</span>
          <span class="stat-value" id="outputChars">0</span>
        </div>
        <div class="stat-item">
          <span>üìñ Headers:</span>
          <span class="stat-value" id="headersKept">0</span>
        </div>
      </div>
    </section>
  </div>

  <footer>
    Made by <strong>3221</strong> | 
    <span style="opacity: 0.7; font-size: 0.8rem;">
      <kbd style="background: rgba(255,255,255,0.2); padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-family: monospace;">Ctrl+Enter</kbd> to clean
    </span>
  </footer>

  <div id="toast" class="toast">
    <span id="toastMessage"></span>
  </div>

  <!-- Header Removal Modal -->
  <div id="headerRemovalModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2>üö´ Custom Header Removal</h2>
        <button class="modal-close" id="closeHeaderRemovalModal">√ó</button>
      </div>
      <p class="modal-description">Checked = REMOVE from email | Unchecked = KEEP in email</p>

      <div style="display: flex; gap: 0.75rem; margin-bottom: 1.5rem;">
        <button id="selectAllHeadersBtn" class="btn btn-blue" style="flex: 1;">‚úì Select All</button>
        <button id="clearAllHeadersBtn" class="btn btn-gray" style="flex: 1;">Clear All</button>
      </div>

      <div class="settings-group">
        <h3>Headers to Remove</h3>
        <div class="checkbox-list" id="headerCheckboxList"></div>
      </div>

      <div class="settings-group">
        <h3>Add Custom Header to Remove</h3>
        <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
          <input type="text" id="customHeaderInput" placeholder="Enter header name (e.g., X-Custom-Header)" style="flex: 1;">
          <button id="addCustomHeaderBtn" class="btn btn-blue">+ Add</button>
        </div>
        <div class="checkbox-list" id="customHeaderCheckboxList"></div>
      </div>

      <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
        <button id="saveHeaderSettingsBtn" class="btn btn-green" style="flex: 1;">üíæ Save Settings</button>
        <button id="closeHeaderRemovalBtn" class="btn btn-gray" style="flex: 1;">Close</button>
      </div>
    </div>
  </div>

  <!-- Project Manager Modal -->
  <div id="projectManagerModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2>üìÅ Project Manager</h2>
        <button class="modal-close" id="closeProjectManagerModal">√ó</button>
      </div>
      <p class="modal-description">Save and load your header configurations</p>

      <div class="settings-group">
        <h3>Save Current Project</h3>
        <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
          <input type="text" id="projectNameInput" placeholder="Enter project name" style="flex: 1;">
          <button id="saveProjectBtn" class="btn btn-blue">üíæ Save</button>
        </div>
      </div>

      <div class="settings-group">
        <h3>Import/Export Project</h3>
        <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
          <input type="file" id="importProjectFile" accept=".json" style="display: none;">
          <button id="importProjectBtn" class="btn btn-blue" style="flex: 1;">üì§ Import Project</button>
          <button id="exportProjectBtn" class="btn btn-green" style="flex: 1;">üì• Export Current</button>
        </div>
      </div>

      <div class="settings-group">
        <h3>Your Saved Projects</h3>
        <div id="savedProjectsList" style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 300px; overflow-y: auto;">
          <p style="color: #9ca3af; text-align: center; padding: 2rem;">No saved projects yet</p>
        </div>
      </div>

      <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
        <button id="closeProjectManagerBtn" class="btn btn-gray" style="flex: 1;">Close</button>
      </div>
    </div>
  </div>

  <!-- Theme Selection Modal -->
  <div id="themeModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2>üé® Choose Your Theme</h2>
        <button class="modal-close" id="closeThemeModal">√ó</button>
      </div>

      <div class="theme-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
        <div class="theme-option" data-theme="dark" style="cursor: pointer; border-radius: 0.75rem; overflow: hidden; border: 2px solid transparent; transition: all 0.2s;">
          <div style="height: 100px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);"></div>
          <div style="padding: 0.75rem; background: #374151; text-align: center; font-weight: 600; color: #f3f4f6;">Dark</div>
        </div>

        <div class="theme-option" data-theme="light" style="cursor: pointer; border-radius: 0.75rem; overflow: hidden; border: 2px solid transparent; transition: all 0.2s;">
          <div style="height: 100px; background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);"></div>
          <div style="padding: 0.75rem; background: #374151; text-align: center; font-weight: 600; color: #f3f4f6;">Light</div>
        </div>

        <div class="theme-option" data-theme="midnight" style="cursor: pointer; border-radius: 0.75rem; overflow: hidden; border: 2px solid transparent; transition: all 0.2s;">
          <div style="height: 100px; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);"></div>
          <div style="padding: 0.75rem; background: #374151; text-align: center; font-weight: 600; color: #f3f4f6;">Midnight Blue</div>
        </div>

        <div class="theme-option" data-theme="forest" style="cursor: pointer; border-radius: 0.75rem; overflow: hidden; border: 2px solid transparent; transition: all 0.2s;">
          <div style="height: 100px; background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);"></div>
          <div style="padding: 0.75rem; background: #374151; text-align: center; font-weight: 600; color: #f3f4f6;">Forest Green</div>
        </div>

        <div class="theme-option" data-theme="sunset" style="cursor: pointer; border-radius: 0.75rem; overflow: hidden; border: 2px solid transparent; transition: all 0.2s;">
          <div style="height: 100px; background: linear-gradient(135deg, #451a03 0%, #78350f 100%);"></div>
          <div style="padding: 0.75rem; background: #374151; text-align: center; font-weight: 600; color: #f3f4f6;">Sunset Orange</div>
        </div>

        <div class="theme-option" data-theme="purple" style="cursor: pointer; border-radius: 0.75rem; overflow: hidden; border: 2px solid transparent; transition: all 0.2s;">
          <div style="height: 100px; background: linear-gradient(135deg, #3b0764 0%, #581c87 100%);"></div>
          <div style="padding: 0.75rem; background: #374151; text-align: center; font-weight: 600; color: #f3f4f6;">Purple Haze</div>
        </div>

        <div class="theme-option" data-theme="ocean" style="cursor: pointer; border-radius: 0.75rem; overflow: hidden; border: 2px solid transparent; transition: all 0.2s;">
          <div style="height: 100px; background: linear-gradient(135deg, #042f2e 0%, #134e4a 100%);"></div>
          <div style="padding: 0.75rem; background: #374151; text-align: center; font-weight: 600; color: #f3f4f6;">Ocean Teal</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Smart Insert Modal -->
  <div id="smartInsertModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2>‚ûï Smart Insert</h2>
        <button class="modal-close" id="closeSmartInsertModal">√ó</button>
      </div>
      <p class="modal-description">Paste content below and choose where to insert it in the cleaned email source.</p>

      <div class="settings-group">
        <h3>Insertion Position</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
          <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: #111827; border-radius: 0.5rem; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" class="insertion-position-option">
            <input type="radio" name="insertionPosition" value="after-transfer-encoding" checked style="cursor: pointer;">
            <div style="flex: 1;">
              <div style="font-weight: 600; color: #f3f4f6; font-size: 0.9rem;">After Transfer Encoding</div>
              <div style="font-size: 0.75rem; color: #9ca3af;">Under Content-Transfer-Encoding</div>
            </div>
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: #111827; border-radius: 0.5rem; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" class="insertion-position-option">
            <input type="radio" name="insertionPosition" value="after-content-type" style="cursor: pointer;">
            <div style="flex: 1;">
              <div style="font-weight: 600; color: #f3f4f6; font-size: 0.9rem;">After Content-Type</div>
              <div style="font-size: 0.75rem; color: #9ca3af;">Right after Content-Type header</div>
            </div>
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: #111827; border-radius: 0.5rem; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" class="insertion-position-option">
            <input type="radio" name="insertionPosition" value="before-body" style="cursor: pointer;">
            <div style="flex: 1;">
              <div style="font-weight: 600; color: #f3f4f6; font-size: 0.9rem;">Before Body</div>
              <div style="font-size: 0.75rem; color: #9ca3af;">Just before email body content</div>
            </div>
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: #111827; border-radius: 0.5rem; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" class="insertion-position-option">
            <input type="radio" name="insertionPosition" value="after-headers" style="cursor: pointer;">
            <div style="flex: 1;">
              <div style="font-weight: 600; color: #f3f4f6; font-size: 0.9rem;">After All Headers</div>
              <div style="font-size: 0.75rem; color: #9ca3af;">After the blank line separator</div>
            </div>
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: #111827; border-radius: 0.5rem; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" class="insertion-position-option">
            <input type="radio" name="insertionPosition" value="before-doctype" style="cursor: pointer;">
            <div style="flex: 1;">
              <div style="font-weight: 600; color: #f3f4f6; font-size: 0.9rem;">Before DOCTYPE</div>
              <div style="font-size: 0.75rem; color: #9ca3af;">Above &lt;!DOCTYPE html&gt; tag</div>
            </div>
          </label>
        </div>
      </div>

      <div class="settings-group">
        <h3>Content to Insert</h3>
        <textarea id="smartInsertContent" placeholder="Paste your HTML or text content here..." style="min-height: 250px; font-family: 'Courier New', Courier, monospace; resize: vertical;"></textarea>
        <div style="margin-top: 1rem; padding: 0.75rem; background: #111827; border-radius: 0.5rem;">
          <div style="display: flex; align-items: center; gap: 0.5rem; color: #9ca3af; font-size: 0.9rem; margin-bottom: 0.5rem;">
            <span style="font-weight: 600;">Content Type:</span>
            <span id="contentTypeDetection" style="color: #3b82f6;">Waiting for input...</span>
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem; color: #9ca3af; font-size: 0.9rem; margin-bottom: 0.5rem;">
            <span style="font-weight: 600;">Encoding Detected:</span>
            <span id="encodingDetection" style="color: #8b5cf6;">-</span>
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem; color: #9ca3af; font-size: 0.9rem; margin-bottom: 0.5rem;">
            <span style="font-weight: 600;">Encoding Validation:</span>
            <span id="encodingValidation" style="color: #10b981;">-</span>
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem; color: #9ca3af; font-size: 0.9rem;">
            <span style="font-weight: 600;">Characters:</span>
            <span id="insertContentChars" style="color: #10b981;">0</span>
          </div>
        </div>
      </div>

      <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
        <button id="applySmartInsertBtn" class="btn btn-green" style="flex: 1;">‚úî Insert Content</button>
        <button id="clearSmartInsertBtn" class="btn btn-gray" style="flex: 1;">üóëÔ∏è Clear</button>
      </div>
    </div>
  </div>

  <!-- Batch Upload Modal -->
  <div id="batchUploadModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2>üì¶ Batch Upload & Clean</h2>
        <button class="modal-close" id="closeBatchUploadModal">√ó</button>
      </div>
      <p class="modal-description">Upload multiple .txt files to clean them all at once and export as a zip file</p>

      <div class="settings-group">
        <h3>Upload Files</h3>
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <input type="file" id="batchFileInput" accept=".txt" multiple style="display: none;">
          <button id="selectFilesBtn" class="btn btn-blue" style="width: 100%;">
            üìÅ Select Files (.txt)
          </button>
          <div id="fileListContainer" style="max-height: 300px; overflow-y: auto; background: #111827; border-radius: 0.5rem; padding: 1rem;">
            <p style="color: #9ca3af; text-align: center;">No files selected</p>
          </div>
        </div>
      </div>

      <div class="settings-group">
        <h3>Processing Status</h3>
        <div id="batchProgressContainer" style="display: none;">
          <div style="background: #111827; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
              <span style="color: #f3f4f6;">Progress:</span>
              <span id="batchProgressText" style="color: #3b82f6; font-weight: 600;">0 / 0</span>
            </div>
            <div style="background: #374151; border-radius: 0.25rem; height: 8px; overflow: hidden;">
              <div id="batchProgressBar" style="background: #3b82f6; height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
          </div>
          <div id="batchStatusLog" style="background: #111827; border-radius: 0.5rem; padding: 1rem; max-height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; color: #9ca3af;">
          </div>
        </div>
      </div>

      <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
        <button id="processBatchBtn" class="btn btn-green" style="flex: 1;" disabled>
          üßπ Process All Files
        </button>
        <button id="exportBatchBtn" class="btn btn-blue" style="flex: 1;" disabled>
          üì• Export as ZIP
        </button>
        <button id="closeBatchBtn" class="btn btn-gray" style="flex: 1;">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Replacement Headers Modal -->
  <div id="replacementHeadersModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2>üîÑ Replacement Headers</h2>
        <button class="modal-close" id="closeReplacementHeadersModal">√ó</button>
      </div>
      <p class="modal-description">Enter replacement headers (one per line). Existing headers will be replaced, new headers will be added.</p>

      <!-- New replacement fields -->
      <div class="settings-group">
        <h3>Quick Replacements</h3>
        <div class="replacement-fields">
          <div class="replacement-field">
            <label for="replaceSubject">Replace Subject</label>
            <input type="text" id="replaceSubject" placeholder="New subject line">
            <div class="field-description">Replaces the entire Subject header</div>
          </div>
          <div class="replacement-field">
            <label for="replaceFromDomain">Replace From Domain</label>
            <input type="text" id="replaceFromDomain" placeholder="example.com">
            <div class="field-description">Replaces domain in From header (after @)</div>
          </div>
          <div class="replacement-field">
            <label for="replaceFromEmail">Replace From Email</label>
            <input type="text" id="replaceFromEmail" placeholder="example@example.com">
            <label style="display: flex; align-items: center; gap: 0.375rem; cursor: pointer; margin: 0.5rem 0 0 0;">
              <input type="checkbox" id="replaceFromEmailEnabled" style="cursor: pointer; width: auto; margin: 0;">
              <span style="font-size: 0.85rem; color: #9ca3af;">Enable replacement</span>
            </label>
            <div class="field-description">Replaces the entire email address in From header</div>
          </div>
          <div class="replacement-field">
            <label for="replaceFromName">Replace From Name</label>
            <input type="text" id="replaceFromName" placeholder="New Display Name">
            <label style="display: flex; align-items: center; gap: 0.375rem; cursor: pointer; margin: 0.5rem 0 0 0;">
              <input type="checkbox" id="replaceFromNameEnabled" style="cursor: pointer; width: auto; margin: 0;">
              <span style="font-size: 0.85rem; color: #9ca3af;">Enable replacement</span>
            </label>
            <div class="field-description">Replaces the display name in From header</div>
          </div>
          <div class="replacement-field">
            <label for="replaceMessageIdPrefix">Replace Message-ID Prefix</label>
            <input type="text" id="replaceMessageIdPrefix" placeholder="example2">
            <div style="display: flex; gap: 1rem; margin-top: 0.5rem; align-items: center;">
              <label style="display: flex; align-items: center; gap: 0.375rem; cursor: pointer; margin: 0;">
                <input type="radio" name="messageIdPosition" value="start" style="cursor: pointer; width: auto; margin: 0;">
                <span style="font-size: 0.85rem; color: #9ca3af;">At the start</span>
              </label>
              <label style="display: flex; align-items: center; gap: 0.375rem; cursor: pointer; margin: 0;">
                <input type="radio" name="messageIdPosition" value="beforeAt" checked style="cursor: pointer; width: auto; margin: 0;">
                <span style="font-size: 0.85rem; color: #9ca3af;">Before @ symbol</span>
              </label>
            </div>
            <div class="field-description">Choose where to add the prefix in Message-ID</div>
          </div>
        </div>
      </div>

      <div class="settings-group">
        <h3>Custom Replacement Headers</h3>
        <textarea id="replacementHeaders" class="settings-textarea" placeholder="Enter headers to replace, one per line&#10;Example:&#10;To: [*to]&#10;From: [*from]&#10;Cc: [*cc]" style="min-height: 200px; font-family: 'Courier New', Courier, monospace; resize: vertical;"></textarea>
      </div>

      <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
        <button id="applyReplacementHeadersBtn" class="btn btn-blue" style="flex: 1;">‚úî Apply Headers</button>
        <button id="clearReplacementHeadersBtn" class="btn btn-gray" style="flex: 1;">üóëÔ∏è Clear</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    const HEADERS_TO_KEEP = [
      "received",
      "from",
      "sender",
      "message-id",
      "subject",
      "mime-version",
      "content-type",
      "date",
      "feedback-id",
      "to",
      "cc",
      "delivered-to",
      "list-unsubscribe",
      "list-unsubscribe-post",
      "in-reply-to",
      "references",
      "reply-to"
    ];

    const DEFAULT_HEADERS_TO_REMOVE = [
      "arc-seal",
      "arc-message-signature",
      "arc-authentication-results",
      "return-path",
      "authentication-results",
      "received-spf",
      "dkim-signature",
      "reply-to",
      "delivered-to",
      "to",
      "cc",
      "list-unsubscribe",
      "list-unsubscribe-post",
      "in-reply-to",
      "references"
    ];

    let removeAllXHeaders = false;
    let replacementHeadersText = '';
    let replaceSubject = '';
    let replaceFromDomain = '';
    let replaceFromEmail = ''; // New variable for from email
    let replaceFromEmailEnabled = false; // New variable for from email checkbox
    let replaceFromName = ''; // New variable for from name
    let replaceFromNameEnabled = false; // New variable for from name checkbox
    let replaceMessageIdPrefix = '';
    let messageIdPrefixPosition = 'beforeAt'; // Default: add before @ symbol

    // Elements
    const inputEl = document.getElementById('input');
    const outpre = document.getElementById('outpre');
    const outputEl = document.getElementById('output');
    const cleanBtn = document.getElementById('cleanBtn');
    const copyBtn = document.getElementById('copyBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const clearInputBtn = document.getElementById('clearInputBtn');
    const clearOutputBtn = document.getElementById('clearOutputBtn');
    const headerRemovalBtn = document.getElementById('headerRemovalBtn');
    const replacementHeadersBtn = document.getElementById('replacementHeadersBtn');
    const themeToggle = document.getElementById('themeToggle');
    const projectManagerBtn = document.getElementById('projectManagerBtn');
    const headerRemovalModal = document.getElementById('headerRemovalModal');
    const replacementHeadersModal = document.getElementById('replacementHeadersModal');
    const projectManagerModal = document.getElementById('projectManagerModal');
    const themeModal = document.getElementById('themeModal');
    const closeHeaderRemovalModal = document.getElementById('closeHeaderRemovalModal');
    const closeReplacementHeadersModal = document.getElementById('closeReplacementHeadersModal');
    const closeProjectManagerModal = document.getElementById('closeProjectManagerModal');
    const closeProjectManagerBtn = document.getElementById('closeProjectManagerBtn');
    const closeThemeModal = document.getElementById('closeThemeModal');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');

    const inputLines = document.getElementById('inputLines');
    const inputChars = document.getElementById('inputChars');
    const outputLines = document.getElementById('outputLines');
    const outputChars = document.getElementById('outputChars');
    const headersKept = document.getElementById('headersKept');

    // Header Removal elements
    const headerCheckboxList = document.getElementById('headerCheckboxList');
    const customHeaderCheckboxList = document.getElementById('customHeaderCheckboxList');
    const customHeaderInput = document.getElementById('customHeaderInput');
    const addCustomHeaderBtn = document.getElementById('addCustomHeaderBtn');
    const selectAllHeadersBtn = document.getElementById('selectAllHeadersBtn');
    const clearAllHeadersBtn = document.getElementById('clearAllHeadersBtn');

    // Replacement Headers elements
    const replacementHeadersTextarea = document.getElementById('replacementHeaders');
    const applyReplacementHeadersBtn = document.getElementById('applyReplacementHeadersBtn');
    const clearReplacementHeadersBtn = document.getElementById('clearReplacementHeadersBtn');
    const replaceSubjectInput = document.getElementById('replaceSubject');
    const replaceFromDomainInput = document.getElementById('replaceFromDomain');
    const replaceFromEmailInput = document.getElementById('replaceFromEmail'); // New element
    const replaceFromEmailEnabledInput = document.getElementById('replaceFromEmailEnabled'); // New element
    const replaceFromNameInput = document.getElementById('replaceFromName'); // New element for From Name
    const replaceFromNameEnabledInput = document.getElementById('replaceFromNameEnabled'); // New element for From Name enabled
    const replaceMessageIdPrefixInput = document.getElementById('replaceMessageIdPrefix');

    // Smart Insert elements
    const smartInsertBtn = document.getElementById('smartInsertBtn');
    const smartInsertModal = document.getElementById('smartInsertModal');
    const closeSmartInsertModal = document.getElementById('closeSmartInsertModal');
    const smartInsertContent = document.getElementById('smartInsertContent');
    const applySmartInsertBtn = document.getElementById('applySmartInsertBtn');
    const clearSmartInsertBtn = document.getElementById('clearSmartInsertBtn');
    const contentTypeDetection = document.getElementById('contentTypeDetection');
    const insertLocationText = document.getElementById('insertLocationText');

    // Batch Upload elements
    const batchUploadBtn = document.getElementById('batchUploadBtn');
    const batchUploadModal = document.getElementById('batchUploadModal');
    const closeBatchUploadModal = document.getElementById('closeBatchUploadModal');
    const closeBatchBtn = document.getElementById('closeBatchBtn');
    const batchFileInput = document.getElementById('batchFileInput');
    const selectFilesBtn = document.getElementById('selectFilesBtn');
    const fileListContainer = document.getElementById('fileListContainer');
    const processBatchBtn = document.getElementById('processBatchBtn');
    const exportBatchBtn = document.getElementById('exportBatchBtn');
    const batchProgressContainer = document.getElementById('batchProgressContainer');
    const batchProgressBar = document.getElementById('batchProgressBar');
    const batchProgressText = document.getElementById('batchProgressText');
    const batchStatusLog = document.getElementById('batchStatusLog');

    let batchFiles = [];
    let processedBatchResults = [];

    // Project Manager elements
    const projectNameInput = document.getElementById('projectNameInput');
    const saveProjectBtn = document.getElementById('saveProjectBtn');
    const savedProjectsList = document.getElementById('savedProjectsList');

    let headersToRemove = [...DEFAULT_HEADERS_TO_REMOVE];
    let customHeaders = [];
    let savedProjects = [];

    function showToast(message, isError = false) {
      toastMessage.textContent = message;
      toast.classList.toggle('error', isError);
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    function initHeaderCheckboxes() {
      headerCheckboxList.innerHTML = '';

      // Add X-Headers checkbox first
      const xHeaderItem = document.createElement('div');
      xHeaderItem.className = 'checkbox-item';
      xHeaderItem.innerHTML = `
        <input type="checkbox" id="header-x-headers" ${removeAllXHeaders ? 'checked' : ''}>
        <label for="header-x-headers"><strong>X-Headers (all)</strong></label>
      `;
      headerCheckboxList.appendChild(xHeaderItem);
      xHeaderItem.querySelector('input').addEventListener('change', () => {
        removeAllXHeaders = xHeaderItem.querySelector('input').checked;
        updateHeadersToRemove();
        saveHeaderSettings();
      });

      // Add separator
      const separator = document.createElement('div');
      separator.style.borderTop = '1px solid #4b5563';
      separator.style.margin = '0.75rem 0';
      headerCheckboxList.appendChild(separator);

      // Add standard headers
      DEFAULT_HEADERS_TO_REMOVE.forEach((h, idx) => {
        const item = document.createElement('div');
        item.className = 'checkbox-item';
        item.innerHTML = `
          <input type="checkbox" id="header-${h}" ${headersToRemove.includes(h) ? 'checked' : ''}>
          <label for="header-${h}">${h}</label>
        `;
        headerCheckboxList.appendChild(item);
        item.querySelector('input').addEventListener('change', updateHeadersToRemove);
      });
    }

    function initCustomHeaderCheckboxes() {
      customHeaderCheckboxList.innerHTML = '';
      customHeaders.forEach((h, idx) => {
        const item = document.createElement('div');
        item.className = 'checkbox-item';
        item.innerHTML = `
          <input type="checkbox" id="custom-header-${idx}" ${headersToRemove.includes(h) ? 'checked' : ''}>
          <label for="custom-header-${idx}">${h}</label>
          <button class="btn btn-red" style="padding: 0.375rem 0.625rem; font-size: 0.75rem;" onclick="removeCustomHeader(${idx})">Remove</button>
        `;
        customHeaderCheckboxList.appendChild(item);
        item.querySelector('input').addEventListener('change', updateHeadersToRemove);
      });
    }

    function removeCustomHeader(idx) {
      customHeaders.splice(idx, 1);
      headersToRemove = headersToRemove.filter(h => !customHeaders.includes(h) || DEFAULT_HEADERS_TO_REMOVE.includes(h));
      saveHeaderSettings();
      initCustomHeaderCheckboxes();
    }

    function updateHeadersToRemove() {
      headersToRemove = [];

      // Add X-Headers if checked
      if (removeAllXHeaders) {
        headersToRemove.push('x-headers');
      }

      // Add standard headers
      const standardCheckboxes = headerCheckboxList.querySelectorAll('input[type="checkbox"]');
      standardCheckboxes.forEach((cb, idx) => {
        if (idx > 0 && cb.checked) { // Skip the first checkbox (X-Headers)
          const label = cb.nextElementSibling.textContent.toLowerCase();
          if (DEFAULT_HEADERS_TO_REMOVE.includes(label)) {
            headersToRemove.push(label);
          }
        }
      });

      // Add custom headers
      const customCheckboxes = customHeaderCheckboxList.querySelectorAll('input[type="checkbox"]');
      customCheckboxes.forEach((cb, idx) => {
        if (cb.checked && customHeaders[idx]) {
          headersToRemove.push(customHeaders[idx]);
        }
      });

      saveHeaderSettings();
    }

    function saveHeaderSettings() {
      localStorage.setItem('removeAllXHeaders', removeAllXHeaders);
      localStorage.setItem('headersToRemove', JSON.stringify(headersToRemove));
      localStorage.setItem('customHeaders', JSON.stringify(customHeaders));
    }

    function loadHeaderSettings() {
      removeAllXHeaders = localStorage.getItem('removeAllXHeaders') === 'true';
      const savedHeadersToRemove = localStorage.getItem('headersToRemove');
      if (savedHeadersToRemove) {
        headersToRemove = JSON.parse(savedHeadersToRemove);
      }
      const savedCustomHeaders = localStorage.getItem('customHeaders');
      if (savedCustomHeaders) {
        customHeaders = JSON.parse(savedCustomHeaders);
      }
    }

    function applySyntaxHighlighting(text) {
      const lines = text.split('\n');
      let inBody = false;
      const highlightedLines = [];

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];

        // Check if we've reached the body (empty line after headers)
        if (!inBody && line.trim() === '') {
          inBody = true;
          highlightedLines.push(line);
          continue;
        }

        if (!inBody) {
          // This is a header line
          const headerMatch = line.match(/^([a-zA-Z0-9\-]+):\s*(.*)/);
          if (headerMatch) {
            const headerName = headerMatch[1];
            const headerValue = headerMatch[2];
            highlightedLines.push(
              `<span class="email-header-name">${escapeHtml(headerName)}:</span> ${escapeHtml(headerValue)}`
            );
          } else {
            // Continuation line - keep original color
            highlightedLines.push(escapeHtml(line));
          }
        } else {
          // Body content - keep original color without styling
          highlightedLines.push(escapeHtml(line));
        }
      }

      return highlightedLines.join('\n');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function updateStats() {
      const inputText = inputEl.value;
      const outputText = outpre.textContent;

      inputLines.textContent = inputText ? inputText.split('\n').length : 0;
      inputChars.textContent = inputText.length;

      if (outputText !== '[No output yet] Paste email source and click Clean to get started.') {
        outputLines.textContent = outputText ? outputText.split('\n').length : 0;
        outputChars.textContent = outputText.length;

        // Count headers in output
        const headerCount = (outputText.match(/^[a-zA-Z0-9\-]+:/gm) || []).length;
        headersKept.textContent = headerCount;
      } else {
        outputLines.textContent = 0;
        outputChars.textContent = 0;
        headersKept.textContent = 0;
      }
    }

    function cleanEmail() {
      const input = inputEl.value.trim();
      if (!input) {
        showToast('Please enter email source to clean', true);
        return;
      }

      try {
        const lines = input.split('\n');
        const cleanedLines = [];
        let inHeaders = true;
        let headerCount = 0;
        let skipCurrentHeader = false;
        let currentHeaderName = '';

        // Find the first Delivered-To header to start from
        let startIndex = 0;
        for (let i = 0; i < lines.length; i++) {
          const headerMatch = lines[i].match(/^([a-zA-Z0-9\-]+):\s*(.*)/);
          if (headerMatch && headerMatch[1].toLowerCase() === 'delivered-to') {
            startIndex = i;
            break;
          }
        }

        for (let i = startIndex; i < lines.length; i++) {
          const line = lines[i];

          // Check if we've reached the end of headers
          if (inHeaders && line.trim() === '') {
            inHeaders = false;
            cleanedLines.push(line);
            skipCurrentHeader = false;
            continue;
          }

          // Process headers
          if (inHeaders) {
            const headerMatch = line.match(/^([a-zA-Z0-9\-]+):\s*(.*)/);

            // If this is a new header line (not a continuation)
            if (headerMatch) {
              const headerName = headerMatch[1].toLowerCase();
              const headerValue = headerMatch[2];

              // Check if we should remove this header
              const shouldRemove = 
                headersToRemove.includes(headerName) ||
                (removeAllXHeaders && headerName.startsWith('x-'));

              if (shouldRemove) {
                // Skip this entire header (including continuation lines)
                skipCurrentHeader = true;
                currentHeaderName = headerName;
                continue;
              } else {
                // Keep this header
                skipCurrentHeader = false;

                // Apply replacements if needed
                let finalHeaderValue = headerValue;

                // Subject replacement
                if (headerName === 'subject' && replaceSubject) {
                  finalHeaderValue = replaceSubject;
                }

                // From domain replacement
                if (headerName === 'from' && replaceFromDomain) {
                  finalHeaderValue = finalHeaderValue.replace(/@[^\s>]+/, '@' + replaceFromDomain);
                }

                // From email replacement (applied AFTER domain replacement)
                if (headerName === 'from' && replaceFromEmailEnabled && replaceFromEmail) {
                  // Extract the display name part if it exists
                  const fromMatch = finalHeaderValue.match(/^(.+?)\s*<(.+?)>\s*$/);
                  if (fromMatch) {
                    const displayName = fromMatch[1].trim();
                    finalHeaderValue = `${displayName} <${replaceFromEmail}>`;
                  } else {
                    // Plain email or email in brackets without display name
                    finalHeaderValue = `<${replaceFromEmail}>`;
                  }
                } else if (headerName === 'from') {
                  // Ensure From email is always in angle brackets (even when not replacing)
                  const fromMatch = finalHeaderValue.match(/^(.+?)\s*<(.+?)>\s*$/);
                  if (fromMatch) {
                    // Already has display name and angle brackets - normalize formatting
                    finalHeaderValue = `${fromMatch[1].trim()} <${fromMatch[2].trim()}>`;
                  } else if (!finalHeaderValue.match(/^<.+>$/)) {
                    // Plain email without brackets - add them
                    finalHeaderValue = `<${finalHeaderValue.trim()}>`;
                  }
                }

                // From Name replacement (only if checkbox is enabled)
                if (headerName === 'from' && replaceFromNameEnabled) {
                  const fromMatch = finalHeaderValue.match(/^(.+?)\s*<(.+?)>\s*$/);
                  if (fromMatch) {
                    // Format: "Display Name <email@domain.com>"
                    const emailPart = fromMatch[2];
                    if (replaceFromName.trim()) {
                      // Field has text: replace the display name with new name
                      finalHeaderValue = `${replaceFromName} <${emailPart}>`;
                    } else {
                      // Field is empty: remove display name, keep only email
                      finalHeaderValue = emailPart;
                    }
                  } else {
                    // Format: just email address or <email@domain.com>
                    const emailOnly = finalHeaderValue.replace(/^<|>$/g, '').trim();
                    if (replaceFromName.trim()) {
                      // Add display name to plain email
                      finalHeaderValue = `${replaceFromName} <${emailOnly}>`;
                    }
                    // If replaceFromName is empty, keep as is (plain email)
                  }
                }

                // Message-ID prefix replacement
                if (headerName === 'message-id' && replaceMessageIdPrefix) {
                  // Extract the content between < and >
                  const messageIdMatch = finalHeaderValue.match(/^<([^@]+)(@.*)>$/);
                  if (messageIdMatch) {
                    const beforeAt = messageIdMatch[1];
                    const afterAt = messageIdMatch[2];

                    // Insert prefix based on messageIdPrefixPosition
                    if (messageIdPrefixPosition === 'start') {
                      // Add at the start
                      finalHeaderValue = `<${replaceMessageIdPrefix}${beforeAt}${afterAt}>`;
                    } else {
                      // Add before @ symbol (default)
                      finalHeaderValue = `<${beforeAt}${replaceMessageIdPrefix}${afterAt}>`;
                    }
                  }
                }

                cleanedLines.push(`${headerMatch[1]}: ${finalHeaderValue}`);
                headerCount++;
              }
            } else {
              // This is a continuation line (starts with space/tab)
              if (!skipCurrentHeader && cleanedLines.length > 0) {
                // Add continuation line to the current header
                cleanedLines[cleanedLines.length - 1] += '\n' + line;
              }
              // If skipCurrentHeader is true, we skip this continuation line too
            }
          } else {
            // Body content
            cleanedLines.push(line);
          }
        }

        // Apply custom replacement headers - FIXED: Insert them in proper position
        if (replacementHeadersText) {
          const replacementLines = replacementHeadersText.split('\n');
          let replacementHeadersAdded = [];

          // Process replacement headers in reverse order to maintain proper insertion order
          for (let i = replacementLines.length - 1; i >= 0; i--) {
            const line = replacementLines[i].trim();
            if (!line) continue;

            const headerMatch = line.match(/^([a-zA-Z0-9\-]+):\s*(.*)/);
            if (headerMatch) {
              const headerName = headerMatch[1];
              const headerValue = headerMatch[2];
              const headerNameLower = headerName.toLowerCase();

              // Check if this header already exists
              let headerReplaced = false;
              for (let j = 0; j < cleanedLines.length; j++) {
                const existingHeaderMatch = cleanedLines[j].match(/^([a-zA-Z0-9\-]+):\s*(.*)/);
                if (existingHeaderMatch && existingHeaderMatch[1].toLowerCase() === headerNameLower) {
                  // Replace existing header
                  cleanedLines[j] = `${headerName}: ${headerValue}`;
                  headerReplaced = true;
                  break;
                }
              }

              // If header doesn't exist, find the best position to insert it
              if (!headerReplaced) {
                // Find the position where this header should be inserted
                let insertPosition = -1;

                // Common header order in emails
                const headerOrder = [
                  "return-path", "received", "from", "sender", "to", "cc", "bcc",
                  "message-id", "in-reply-to", "references", "subject", "date",
                  "mime-version", "content-type", "content-transfer-encoding"
                ];

                const currentHeaderIndex = headerOrder.indexOf(headerNameLower);

                if (currentHeaderIndex !== -1) {
                  // Find the position to insert based on header order
                  for (let j = 0; j < cleanedLines.length; j++) {
                    const existingHeaderMatch = cleanedLines[j].match(/^([a-zA-Z0-9\-]+):\s*(.*)/);
                    if (existingHeaderMatch) {
                      const existingHeaderName = existingHeaderMatch[1].toLowerCase();
                      const existingHeaderIndex = headerOrder.indexOf(existingHeaderName);

                      if (existingHeaderIndex !== -1 && existingHeaderIndex > currentHeaderIndex) {
                        insertPosition = j;
                        break;
                      }
                    }
                  }
                }

                // If no specific position found, insert before the body
                if (insertPosition === -1) {
                  const firstBodyLineIndex = cleanedLines.findIndex(line => line.trim() === '');
                  insertPosition = firstBodyLineIndex !== -1 ? firstBodyLineIndex : cleanedLines.length;
                }

                // Insert the new header
                cleanedLines.splice(insertPosition, 0, `${headerName}: ${headerValue}`);
                headerCount++;
              }

              replacementHeadersAdded.push(headerName);
            }
          }

          if (replacementHeadersAdded.length > 0) {
            showToast(`Added/replaced headers: ${replacementHeadersAdded.join(', ')}`);
          }
        }

        const cleanedText = cleanedLines.join('\n');

        // Apply syntax highlighting
        const highlightedHTML = applySyntaxHighlighting(cleanedText);
        outpre.innerHTML = highlightedHTML;

        outputEl.classList.add('has-content');
        copyBtn.disabled = false;
        downloadBtn.disabled = false;

        updateStats();
        showToast(`Email cleaned successfully! Kept ${headerCount} headers.`);
      } catch (error) {
        console.error('Error cleaning email:', error);
        showToast('Error cleaning email. Please check the format.', true);
      }
    }

    function copyOutput() {
      // Get plain text without HTML formatting
      const text = outpre.textContent || outpre.innerText;
      navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard!');
      }).catch(err => {
        console.error('Failed to copy: ', err);
        showToast('Failed to copy to clipboard', true);
      });
    }

    function downloadOutput() {
      const text = outpre.textContent;
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'cleaned-email.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast('Downloaded cleaned email!');
    }

    function clearInput() {
      inputEl.value = '';
      updateStats();
      showToast('Input cleared');
    }

    function clearOutput() {
      outpre.innerHTML = '[No output yet] Paste email source and click Clean to get started.';
      outputEl.classList.remove('has-content');
      copyBtn.disabled = true;
      downloadBtn.disabled = true;
      updateStats();
      showToast('Output cleared');
    }

    function applyTheme(themeName) {
      // Remove all theme classes
      document.body.classList.remove('dark-mode', 'light-theme', 'midnight-theme', 'forest-theme', 'sunset-theme', 'purple-theme', 'ocean-theme');

      // Apply new theme
      if (themeName === 'dark') {
        document.body.classList.add('dark-mode');
      } else if (themeName === 'light') {
        document.body.classList.add('light-theme');
      } else {
        document.body.classList.add(`${themeName}-theme`);
      }

      // Save to localStorage
      localStorage.setItem('selectedTheme', themeName);

      // Update active state
      document.querySelectorAll('.theme-option').forEach(option => {
        option.classList.remove('active');
        if (option.dataset.theme === themeName) {
          option.classList.add('active');
        }
      });

      showToast(`Theme changed to ${themeName.charAt(0).toUpperCase() + themeName.slice(1)}`);
    }

    function initTheme() {
      const savedTheme = localStorage.getItem('selectedTheme') || 'dark';
      applyTheme(savedTheme);
    }

    function loadReplacementHeaders() {
      replacementHeadersText = localStorage.getItem('replacementHeaders') || '';
      replacementHeadersTextarea.value = replacementHeadersText;

      replaceSubject = localStorage.getItem('replaceSubject') || '';
      replaceSubjectInput.value = replaceSubject;

      replaceFromDomain = localStorage.getItem('replaceFromDomain') || '';
      replaceFromDomainInput.value = replaceFromDomain;

      replaceFromEmail = localStorage.getItem('replaceFromEmail') || ''; // Load from email
      replaceFromEmailInput.value = replaceFromEmail; // Load from email

      replaceFromEmailEnabled = localStorage.getItem('replaceFromEmailEnabled') === 'true'; // Load from email enabled state
      replaceFromEmailEnabledInput.checked = replaceFromEmailEnabled; // Load from email enabled state

      replaceFromName = localStorage.getItem('replaceFromName') || ''; // Load from name
      replaceFromNameInput.value = replaceFromName; // Load from name

      replaceFromNameEnabled = localStorage.getItem('replaceFromNameEnabled') === 'true'; // Load from name enabled state
      replaceFromNameEnabledInput.checked = replaceFromNameEnabled; // Load from name enabled state

      replaceMessageIdPrefix = localStorage.getItem('replaceMessageIdPrefix') || '';
      replaceMessageIdPrefixInput.value = replaceMessageIdPrefix;

      // Load messageIdPrefixPosition if it exists
      messageIdPrefixPosition = localStorage.getItem('messageIdPrefixPosition') || 'beforeAt';

      // Set radio button state
      const radioButtons = document.querySelectorAll('input[name="messageIdPosition"]');
      radioButtons.forEach(radio => {
        if (radio.value === messageIdPrefixPosition) {
          radio.checked = true;
        }
      });
    }

    function saveProject() {
      const projectName = projectNameInput.value.trim();
      if (!projectName) {
        showToast('Please enter a project name', true);
        return;
      }

      const project = {
        name: projectName,
        timestamp: new Date().toLocaleString(),
        data: {
          removeAllXHeaders: removeAllXHeaders,
          headersToRemove: [...headersToRemove],
          customHeaders: [...customHeaders],
          replacementHeadersText: replacementHeadersText,
          replaceSubject: replaceSubject,
          replaceFromDomain: replaceFromDomain,
          replaceFromEmail: replaceFromEmail, // Added from email
          replaceFromEmailEnabled: replaceFromEmailEnabled, // Added from email enabled
          replaceFromName: replaceFromName, // Added from name
          replaceFromNameEnabled: replaceFromNameEnabled, // Added from name enabled
          replaceMessageIdPrefix: replaceMessageIdPrefix,
          messageIdPrefixPosition: messageIdPrefixPosition, // Added this line
          cleanedOutput: outpre.textContent || outpre.innerText,
          inputText: inputEl.value
        }
      };

      // Check if project name already exists
      const existingIndex = savedProjects.findIndex(p => p.name === projectName);
      if (existingIndex !== -1) {
        savedProjects[existingIndex] = project;
        showToast(`Project "${projectName}" updated!`);
      } else {
        savedProjects.push(project);
        showToast(`Project "${projectName}" saved!`);
      }

      localStorage.setItem('savedProjects', JSON.stringify(savedProjects));
      projectNameInput.value = '';
      renderSavedProjects();
    }

    window.loadProject = function(projectName) {
      const project = savedProjects.find(p => p.name === projectName);
      if (!project) {
        showToast('Project not found', true);
        return;
      }

      // Load all settings
      removeAllXHeaders = project.data.removeAllXHeaders || false;
      headersToRemove = [...(project.data.headersToRemove || [])];
      customHeaders = [...(project.data.customHeaders || [])];
      replacementHeadersText = project.data.replacementHeadersText || '';
      replaceSubject = project.data.replaceSubject || '';
      replaceFromDomain = project.data.replaceFromDomain || '';
      replaceFromEmail = project.data.replaceFromEmail || ''; // Load from email
      replaceFromEmailEnabled = project.data.replaceFromEmailEnabled || false; // Load from email enabled state
      replaceFromName = project.data.replaceFromName || ''; // Load from name
      replaceFromNameEnabled = project.data.replaceFromNameEnabled || false; // Load from name enabled state
      replaceMessageIdPrefix = project.data.replaceMessageIdPrefix || '';
      messageIdPrefixPosition = project.data.messageIdPrefixPosition || 'beforeAt'; // Load position

      // Save to localStorage
      saveHeaderSettings();
      saveReplacementHeaders();

      // Update UI - headers
      initHeaderCheckboxes();
      initCustomHeaderCheckboxes();

      // Update UI - replacement headers
      replacementHeadersTextarea.value = replacementHeadersText;
      replaceSubjectInput.value = replaceSubject;
      replaceFromDomainInput.value = replaceFromDomain;
      replaceFromEmailInput.value = replaceFromEmail; // Update from email input
      replaceFromEmailEnabledInput.checked = replaceFromEmailEnabled; // Update from email enabled checkbox
      replaceFromNameInput.value = replaceFromName; // Update from name input
      replaceFromNameEnabledInput.checked = replaceFromNameEnabled; // Update from name enabled checkbox
      replaceMessageIdPrefixInput.value = replaceMessageIdPrefix;

      // Restore input and cleaned output
      if (project.data.inputText) {
        inputEl.value = project.data.inputText;
      }

      if (project.data.cleanedOutput) {
        const highlightedHTML = applySyntaxHighlighting(project.data.cleanedOutput);
        outpre.innerHTML = highlightedHTML;
        outputEl.classList.add('has-content');
        copyBtn.disabled = false;
        downloadBtn.disabled = false;
        updateStats();
      }

      showToast(`Project "${projectName}" loaded!`);
      projectManagerModal.classList.remove('active');
    }

    window.exportSavedProject = function(projectName) {
      const project = savedProjects.find(p => p.name === projectName);
      if (!project) {
        showToast('Project not found', true);
        return;
      }

      const dataStr = JSON.stringify(project, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${project.name.replace(/\s+/g, '_')}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast(`Project "${projectName}" exported!`);
    }

    window.deleteProject = function(projectName) {
      if (!confirm(`Are you sure you want to delete project "${projectName}"?`)) {
        return;
      }

      savedProjects = savedProjects.filter(p => p.name !== projectName);
      localStorage.setItem('savedProjects', JSON.stringify(savedProjects));
      renderSavedProjects();
      showToast(`Project "${projectName}" deleted`);
    }

    function renderSavedProjects() {
      if (savedProjects.length === 0) {
        savedProjectsList.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 2rem;">No saved projects yet</p>';
        return;
      }

      savedProjectsList.innerHTML = '';
      savedProjects.forEach((project, index) => {
        const projectDiv = document.createElement('div');
        projectDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #111827; border-radius: 0.5rem;';

        projectDiv.innerHTML = `
          <div style="flex: 1;">
            <div style="font-weight: 600; color: #f3f4f6;">${escapeHtml(project.name)}</div>
            <div style="font-size: 0.75rem; color: #9ca3af;">${project.timestamp}</div>
          </div>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-blue project-load-btn" style="padding: 0.375rem 0.75rem; font-size: 0.8rem;" data-project-index="${index}">üíæ Load</button>
            <button class="btn btn-green project-export-btn" style="padding: 0.375rem 0.75rem; font-size: 0.8rem;" data-project-index="${index}">üì• Export</button>
            <button class="btn btn-red project-delete-btn" style="padding: 0.375rem 0.75rem; font-size: 0.8rem;" data-project-index="${index}">üóëÔ∏è Delete</button>
          </div>
        `;

        savedProjectsList.appendChild(projectDiv);
      });

      // Add event listeners
      document.querySelectorAll('.project-load-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const index = parseInt(this.dataset.projectIndex);
          const project = savedProjects[index];
          if (project) loadProject(project.name);
        });
      });

      document.querySelectorAll('.project-export-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const index = parseInt(this.dataset.projectIndex);
          const project = savedProjects[index];
          if (project) exportSavedProject(project.name);
        });
      });

      document.querySelectorAll('.project-delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const index = parseInt(this.dataset.projectIndex);
          const project = savedProjects[index];
          if (project) deleteProject(project.name);
        });
      });
    }

    function loadSavedProjects() {
      const saved = localStorage.getItem('savedProjects');
      if (saved) {
        try {
          savedProjects = JSON.parse(saved);
        } catch (e) {
          console.error('Error loading saved projects:', e);
          savedProjects = [];
        }
      }
      renderSavedProjects();
    }

    function saveReplacementHeaders() {
      localStorage.setItem('replacementHeaders', replacementHeadersText);
      localStorage.setItem('replaceSubject', replaceSubject);
      localStorage.setItem('replaceFromDomain', replaceFromDomain);
      localStorage.setItem('replaceFromEmail', replaceFromEmail); // Save from email
      localStorage.setItem('replaceFromEmailEnabled', replaceFromEmailEnabled); // Save from email enabled state
      localStorage.setItem('replaceFromName', replaceFromName); // Save from name
      localStorage.setItem('replaceFromNameEnabled', replaceFromNameEnabled); // Save from name enabled state
      localStorage.setItem('replaceMessageIdPrefix', replaceMessageIdPrefix);
      localStorage.setItem('messageIdPrefixPosition', messageIdPrefixPosition); // Save position
    }

    // Event Listeners
    cleanBtn.addEventListener('click', cleanEmail);
    copyBtn.addEventListener('click', copyOutput);
    downloadBtn.addEventListener('click', downloadOutput);
    clearInputBtn.addEventListener('click', clearInput);
    clearOutputBtn.addEventListener('click', clearOutput);

    headerRemovalBtn.addEventListener('click', () => {
      headerRemovalModal.classList.add('active');
    });

    projectManagerBtn.addEventListener('click', () => {
      projectManagerModal.classList.add('active');
      renderSavedProjects();
    });

    replacementHeadersBtn.addEventListener('click', () => {
      replacementHeadersModal.classList.add('active');
    });

    closeHeaderRemovalModal.addEventListener('click', () => {
      headerRemovalModal.classList.remove('active');
    });

    const saveHeaderSettingsBtn = document.getElementById('saveHeaderSettingsBtn');
    const closeHeaderRemovalBtn = document.getElementById('closeHeaderRemovalBtn');

    saveHeaderSettingsBtn.addEventListener('click', () => {
      saveHeaderSettings();
      showToast('Header removal settings saved!');
      headerRemovalModal.classList.remove('active');
    });

    closeHeaderRemovalBtn.addEventListener('click', () => {
      headerRemovalModal.classList.remove('active');
    });

    closeReplacementHeadersModal.addEventListener('click', () => {
      replacementHeadersModal.classList.remove('active');
    });

    closeProjectManagerModal.addEventListener('click', () => {
      projectManagerModal.classList.remove('active');
    });

    closeProjectManagerBtn.addEventListener('click', () => {
      projectManagerModal.classList.remove('active');
    });

    closeThemeModal.addEventListener('click', () => {
      themeModal.classList.remove('active');
    });

    saveProjectBtn.addEventListener('click', saveProject);

    projectNameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        saveProject();
      }
    });

    // Import/Export functionality
    const importProjectBtn = document.getElementById('importProjectBtn');
    const importProjectFile = document.getElementById('importProjectFile');
    const exportProjectBtn = document.getElementById('exportProjectBtn');

    importProjectBtn.addEventListener('click', () => {
      importProjectFile.click();
    });

    importProjectFile.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const project = JSON.parse(event.target.result);

          // Validate project structure
          if (!project.name || !project.data) {
            showToast('Invalid project file format', true);
            return;
          }

          // Load the project data
          removeAllXHeaders = project.data.removeAllXHeaders || false;
          headersToRemove = project.data.headersToRemove || [];
          customHeaders = project.data.customHeaders || [];
          replacementHeadersText = project.data.replacementHeadersText || '';
          replaceSubject = project.data.replaceSubject || '';
          replaceFromDomain = project.data.replaceFromDomain || '';
          replaceFromEmail = project.data.replaceFromEmail || ''; // Load from email
          replaceFromEmailEnabled = project.data.replaceFromEmailEnabled || false; // Load from email enabled state
          replaceFromName = project.data.replaceFromName || ''; // Load from name
          replaceFromNameEnabled = project.data.replaceFromNameEnabled || false; // Load from name enabled state
          replaceMessageIdPrefix = project.data.replaceMessageIdPrefix || '';
          messageIdPrefixPosition = project.data.messageIdPrefixPosition || 'beforeAt'; // Load position

          // Save to localStorage
          saveHeaderSettings();
          saveReplacementHeaders();

          // Update UI
          initHeaderCheckboxes();
          initCustomHeaderCheckboxes();
          loadReplacementHeaders();

          // Restore input and cleaned output
          if (project.data.inputText) {
            inputEl.value = project.data.inputText;
          }

          if (project.data.cleanedOutput) {
            const highlightedHTML = applySyntaxHighlighting(project.data.cleanedOutput);
            outpre.innerHTML = highlightedHTML;
            outputEl.classList.add('has-content');
            copyBtn.disabled = false;
            downloadBtn.disabled = false;
            updateStats();
          }

          showToast(`Project "${project.name}" imported successfully!`);
          projectManagerModal.classList.remove('active');
        } catch (error) {
          console.error('Import error:', error);
          showToast('Error importing project file', true);
        }
      };
      reader.readAsText(file);

      // Reset file input
      e.target.value = '';
    });

    exportProjectBtn.addEventListener('click', () => {
      const project = {
        name: projectNameInput.value.trim() || 'Exported_Project_' + new Date().getTime(),
        timestamp: new Date().toLocaleString(),
        data: {
          removeAllXHeaders: removeAllXHeaders,
          headersToRemove: [...headersToRemove],
          customHeaders: [...customHeaders],
          replacementHeadersText: replacementHeadersText,
          replaceSubject: replaceSubject,
          replaceFromDomain: replaceFromDomain,
          replaceFromEmail: replaceFromEmail, // Added from email
          replaceFromEmailEnabled: replaceFromEmailEnabled, // Added from email enabled
          replaceFromName: replaceFromName, // Added from name
          replaceFromNameEnabled: replaceFromNameEnabled, // Added from name enabled
          replaceMessageIdPrefix: replaceMessageIdPrefix,
          messageIdPrefixPosition: messageIdPrefixPosition, // Added this line
          cleanedOutput: outpre.textContent || outpre.innerText,
          inputText: inputEl.value
        }
      };

      const dataStr = JSON.stringify(project, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${project.name.replace(/\s+/g, '_')}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast(`Project "${project.name}" exported!`);
    });

    themeToggle.addEventListener('click', () => {
      themeModal.classList.add('active');
    });

    // Theme option click handlers
    document.querySelectorAll('.theme-option').forEach(option => {
      option.addEventListener('click', () => {
        const theme = option.dataset.theme;
        applyTheme(theme);
        setTimeout(() => {
          themeModal.classList.remove('active');
        }, 300);
      });
    });

    // Smart Insert Modal Events
    const insertContentChars = document.getElementById('insertContentChars');
    const encodingDetection = document.getElementById('encodingDetection');
    const encodingValidation = document.getElementById('encodingValidation');
    let selectedInsertionPosition = 'after-transfer-encoding';

    smartInsertBtn.addEventListener('click', () => {
      smartInsertModal.classList.add('active');
    });

    closeSmartInsertModal.addEventListener('click', () => {
      smartInsertModal.classList.remove('active');
    });

    // Handle insertion position selection
    document.querySelectorAll('input[name="insertionPosition"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        selectedInsertionPosition = e.target.value;

        // Update visual feedback for selected option
        document.querySelectorAll('.insertion-position-option').forEach(option => {
          option.style.borderColor = 'transparent';
          option.style.background = '#111827';
        });

        e.target.closest('.insertion-position-option').style.borderColor = '#3b82f6';
        e.target.closest('.insertion-position-option').style.background = '#1e293b';
      });
    });

    // Detect content type and encoding as user types
    smartInsertContent.addEventListener('input', () => {
      const content = smartInsertContent.value;
      insertContentChars.textContent = content.length;

      if (!content.trim()) {
        contentTypeDetection.textContent = 'Waiting for input...';
        contentTypeDetection.style.color = '#3b82f6';
        encodingDetection.textContent = '-';
        encodingDetection.style.color = '#8b5cf6';
        encodingValidation.textContent = '-';
        encodingValidation.style.color = '#10b981';
        return;
      }

      // Detect content type
      const isHTML = detectHTML(content);
      if (isHTML) {
        contentTypeDetection.textContent = 'üìÑ HTML content';
        contentTypeDetection.style.color = '#10b981';
      } else {
        contentTypeDetection.textContent = 'üìù Plain text';
        contentTypeDetection.style.color = '#8b5cf6';
      }

      // Detect encoding type
      const encoding = detectContentEncoding(content);
      encodingDetection.textContent = encoding;

      if (encoding === 'Base64') {
        encodingDetection.style.color = '#f59e0b';
      } else if (encoding === 'Quoted-Printable') {
        encodingDetection.style.color = '#ec4899';
      } else {
        encodingDetection.style.color = '#10b981';
      }

      // Validate encoding
      const validation = validateEncoding(content, encoding);
      encodingValidation.textContent = validation.message;
      encodingValidation.style.color = validation.valid ? '#10b981' : '#ef4444';
    });

    applySmartInsertBtn.addEventListener('click', () => {
      const content = smartInsertContent.value.trim();

      // Validation
      if (!content) {
        showToast('Please enter content to insert', true);
        return;
      }

      // Get current cleaned output
      const currentOutput = outpre.textContent || outpre.innerText;
      if (!currentOutput || currentOutput === '[No output yet] Paste email source and click Clean to get started.') {
        showToast('Please clean an email first', true);
        return;
      }

      try {
        const lines = currentOutput.split('\n');
        let insertIndex = -1;
        let insertionSuccess = false;

        // Different insertion strategies based on selected position
        switch (selectedInsertionPosition) {
          case 'after-transfer-encoding':
            insertIndex = findInsertionPoint(lines, 'after-transfer-encoding');
            if (insertIndex !== -1) {
              lines.splice(insertIndex, 0, content);
              insertionSuccess = true;
              showToast('‚úì Content inserted after Content-Transfer-Encoding');
            } else {
              showToast('Content-Transfer-Encoding not found in text/html section', true);
              return;
            }
            break;

          case 'after-content-type':
            insertIndex = findInsertionPoint(lines, 'after-content-type');
            if (insertIndex !== -1) {
              lines.splice(insertIndex, 0, content);
              insertionSuccess = true;
              showToast('‚úì Content inserted after Content-Type');
            } else {
              showToast('Content-Type: text/html not found', true);
              return;
            }
            break;

          case 'before-body':
            insertIndex = findInsertionPoint(lines, 'before-body');
            if (insertIndex !== -1) {
              lines.splice(insertIndex, 0, content);
              insertionSuccess = true;
              showToast('‚úì Content inserted before body');
            } else {
              showToast('Email body not found', true);
              return;
            }
            break;

          case 'after-headers':
            insertIndex = findInsertionPoint(lines, 'after-headers');
            if (insertIndex !== -1) {
              lines.splice(insertIndex, 0, content);
              insertionSuccess = true;
              showToast('‚úì Content inserted after headers');
            } else {
              showToast('Header section end not found', true);
              return;
            }
            break;

          case 'before-doctype':
            insertIndex = findInsertionPoint(lines, 'before-doctype');
            if (insertIndex !== -1) {
              lines.splice(insertIndex, 0, content);
              insertionSuccess = true;
              showToast('‚úì Content inserted before DOCTYPE');
            } else {
              showToast('DOCTYPE declaration not found', true);
              return;
            }
            break;
        }

        if (insertionSuccess) {
          const newContent = lines.join('\n');
          const highlightedHTML = applySyntaxHighlighting(newContent);
          outpre.innerHTML = highlightedHTML;
          outputEl.classList.add('has-content');
          copyBtn.disabled = false;
          downloadBtn.disabled = false;
          updateStats();
          smartInsertModal.classList.remove('active');
        }
      } catch (error) {
        console.error('Smart Insert error:', error);
        showToast('Error inserting content. Please try again.', true);
      }
    });

    clearSmartInsertBtn.addEventListener('click', () => {
      smartInsertContent.value = '';
      contentTypeDetection.textContent = 'Waiting for input...';
      contentTypeDetection.style.color = '#3b82f6';
      encodingDetection.textContent = '-';
      encodingDetection.style.color = '#8b5cf6';
      insertContentChars.textContent = '0';
    });

    function detectHTML(content) {
      // Check for common HTML patterns
      const htmlPatterns = [
        /<(!DOCTYPE|html|head|body|div|p|span|a|img|table|tr|td|h[1-6]|ul|ol|li|form|input|button)[>\s]/i,
        /<\/[a-z]+>/i,
        /<!DOCTYPE\s+html/i
      ];

      return htmlPatterns.some(pattern => pattern.test(content));
    }

    function detectContentEncoding(content) {
      // Check for Base64 encoding
      const base64Pattern = /^[A-Za-z0-9+/]+={0,2}$/;
      const lines = content.split('\n');
      const isBase64 = lines.length > 0 && lines.every(line => 
        line.trim() === '' || (line.length % 4 === 0 && base64Pattern.test(line.trim()))
      );

      if (isBase64 && content.length > 50) {
        return 'Base64';
      }

      // Check for Quoted-Printable encoding
      if (/=[0-9A-F]{2}/.test(content)) {
        return 'Quoted-Printable';
      }

      // Check for 8-bit encoding
      if (/[\x80-\xFF]/.test(content)) {
        return '8-bit';
      }

      return '7-bit';
    }

    function validateEncoding(content, encoding) {
      switch(encoding) {
        case 'Base64':
          const base64Pattern = /^[A-Za-z0-9+/\s]+={0,2}$/;
          if (base64Pattern.test(content.replace(/\s/g, ''))) {
            return { valid: true, message: '‚úì Valid Base64' };
          }
          return { valid: false, message: '‚úó Invalid Base64 format' };

        case 'Quoted-Printable':
          const qpPattern = /^[!-<>-~\s=]*$/;
          if (qpPattern.test(content)) {
            return { valid: true, message: '‚úì Valid Quoted-Printable' };
          }
          return { valid: false, message: '‚úó Invalid Quoted-Printable format' };

        case '7-bit':
          if (!/[\x80-\xFF]/.test(content)) {
            return { valid: true, message: '‚úì Valid 7-bit' };
          }
          return { valid: false, message: '‚úó Contains 8-bit characters' };

        case '8-bit':
          return { valid: true, message: '‚úì Valid 8-bit' };

        default:
          return { valid: true, message: '‚úì Valid' };
      }
    }

    function findInsertionPoint(lines, position) {
      let insertIndex = -1;

      switch (position) {
        case 'after-transfer-encoding':
          // Find Content-Type: text/html section
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].toLowerCase();

            if (line.includes('content-type:') && line.includes('text/html')) {
              // Find Content-Transfer-Encoding after this Content-Type
              for (let j = i + 1; j < lines.length; j++) {
                if (lines[j].toLowerCase().startsWith('content-transfer-encoding:')) {
                  insertIndex = j + 1;
                  break;
                }
                // Stop if we hit another section
                if (lines[j].toLowerCase().startsWith('content-type:') || lines[j].trim() === '') {
                  break;
                }
              }
              break;
            }
          }
          break;

        case 'after-content-type':
          // Find Content-Type: text/html and insert right after
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].toLowerCase();
            if (line.includes('content-type:') && line.includes('text/html')) {
              insertIndex = i + 1;
              break;
            }
          }
          break;

        case 'before-body':
          // Find the first empty line (marks end of headers)
          for (let i = 0; i < lines.length; i++) {
            if (lines[i].trim() === '' && i > 0) {
              insertIndex = i;
              break;
            }
          }
          break;

        case 'after-headers':
          // Find the first empty line and insert after it
          for (let i = 0; i < lines.length; i++) {
            if (lines[i].trim() === '' && i > 0) {
              insertIndex = i + 1;
              break;
            }
          }
          break;

        case 'before-doctype':
          // Find <!DOCTYPE html> and insert right before it
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line.toLowerCase().startsWith('<!doctype')) {
              insertIndex = i;
              break;
            }
          }
          break;
      }

      return insertIndex;
    }

    // Batch Upload Modal Events
    batchUploadBtn.addEventListener('click', () => {
      batchUploadModal.classList.add('active');
    });

    closeBatchUploadModal.addEventListener('click', () => {
      batchUploadModal.classList.remove('active');
    });

    closeBatchBtn.addEventListener('click', () => {
      batchUploadModal.classList.remove('active');
    });

    selectFilesBtn.addEventListener('click', () => {
      batchFileInput.click();
    });

    batchFileInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;

      batchFiles = files;
      renderFileList();
      processBatchBtn.disabled = false;
      exportBatchBtn.disabled = true;
      processedBatchResults = [];
      batchProgressContainer.style.display = 'none';
    });

    processBatchBtn.addEventListener('click', processBatchFiles);
    exportBatchBtn.addEventListener('click', exportBatchAsZip);

    function renderFileList() {
      if (batchFiles.length === 0) {
        fileListContainer.innerHTML = '<p style="color: #9ca3af; text-align: center;">No files selected</p>';
        return;
      }

      fileListContainer.innerHTML = '';
      batchFiles.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #1f2937; border-radius: 0.375rem; margin-bottom: 0.5rem;';
        fileItem.innerHTML = `
          <div style="flex: 1; color: #f3f4f6; font-size: 0.9rem;">
            <span style="font-weight: 600;">${index + 1}.</span> ${escapeHtml(file.name)}
            <span style="color: #9ca3af; font-size: 0.8rem; margin-left: 0.5rem;">(${(file.size / 1024).toFixed(2)} KB)</span>
          </div>
          <button class="btn btn-red" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="removeBatchFile(${index})">√ó</button>
        `;
        fileListContainer.appendChild(fileItem);
      });
    }

    window.removeBatchFile = function(index) {
      batchFiles.splice(index, 1);
      renderFileList();
      if (batchFiles.length === 0) {
        processBatchBtn.disabled = true;
      }
    }

    async function processBatchFiles() {
      if (batchFiles.length === 0) {
        showToast('No files to process', true);
        return;
      }

      processedBatchResults = [];
      batchProgressContainer.style.display = 'block';
      batchStatusLog.innerHTML = '';
      processBatchBtn.disabled = true;
      exportBatchBtn.disabled = true;

      for (let i = 0; i < batchFiles.length; i++) {
        const file = batchFiles[i];
        const progress = ((i + 1) / batchFiles.length) * 100;

        batchProgressBar.style.width = `${progress}%`;
        batchProgressText.textContent = `${i + 1} / ${batchFiles.length}`;

        addStatusLog(`Processing: ${file.name}...`);

        try {
          const content = await readFileContent(file);
          const cleaned = cleanEmailContent(content);

          processedBatchResults.push({
            filename: file.name,
            content: cleaned
          });

          addStatusLog(`‚úì Completed: ${file.name}`, 'success');
        } catch (error) {
          console.error(`Error processing ${file.name}:`, error);
          addStatusLog(`‚úó Failed: ${file.name}`, 'error');
        }
      }

      processBatchBtn.disabled = false;
      exportBatchBtn.disabled = false;
      showToast(`Successfully processed ${processedBatchResults.length} files!`);
    }

    function readFileContent(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = (e) => reject(e);
        reader.readAsText(file);
      });
    }

    function cleanEmailContent(input) {
      const lines = input.split('\n');
      const cleanedLines = [];
      let inHeaders = true;
      let skipCurrentHeader = false;

      let startIndex = 0;
      for (let i = 0; i < lines.length; i++) {
        const headerMatch = lines[i].match(/^([a-zA-Z0-9\-]+):\s*(.*)/);
        if (headerMatch && headerMatch[1].toLowerCase() === 'delivered-to') {
          startIndex = i;
          break;
        }
      }

      for (let i = startIndex; i < lines.length; i++) {
        const line = lines[i];

        if (inHeaders && line.trim() === '') {
          inHeaders = false;
          cleanedLines.push(line);
          skipCurrentHeader = false;
          continue;
        }

        if (inHeaders) {
          const headerMatch = line.match(/^([a-zA-Z0-9\-]+):\s*(.*)/);

          if (headerMatch) {
            const headerName = headerMatch[1].toLowerCase();
            const headerValue = headerMatch[2];

            const shouldRemove = 
              headersToRemove.includes(headerName) ||
              (removeAllXHeaders && headerName.startsWith('x-'));

            if (shouldRemove) {
              skipCurrentHeader = true;
              continue;
            } else {
              skipCurrentHeader = false;

              let finalHeaderValue = headerValue;

              if (headerName === 'subject' && replaceSubject) {
                finalHeaderValue = replaceSubject;
              }

              if (headerName === 'from' && replaceFromDomain) {
                finalHeaderValue = finalHeaderValue.replace(/@[^\s>]+/, '@' + replaceFromDomain);
              }

              if (headerName === 'from' && replaceFromEmailEnabled && replaceFromEmail) {
                const fromMatch = finalHeaderValue.match(/^(.+?)\s*<(.+?)>\s*$/);
                if (fromMatch) {
                  const displayName = fromMatch[1].trim();
                  finalHeaderValue = `${displayName} <${replaceFromEmail}>`;
                } else {
                  // Plain email or email in brackets without display name
                  finalHeaderValue = `<${replaceFromEmail}>`;
                }
              } else if (headerName === 'from') {
                // Ensure From email is always in angle brackets (even when not replacing)
                const fromMatch = finalHeaderValue.match(/^(.+?)\s*<(.+?)>\s*$/);
                if (fromMatch) {
                  // Already has display name and angle brackets - normalize formatting
                  finalHeaderValue = `${fromMatch[1].trim()} <${fromMatch[2].trim()}>`;
                } else if (!finalHeaderValue.match(/^<.+>$/)) {
                  // Plain email without brackets - add them
                  finalHeaderValue = `<${finalHeaderValue.trim()}>`;
                }
              }

              if (headerName === 'from' && replaceFromNameEnabled) {
                const fromMatch = finalHeaderValue.match(/^(.+?)\s*<(.+?)>\s*$/);
                if (fromMatch) {
                  // Format: "Display Name <email@domain.com>"
                  const emailPart = fromMatch[2];
                  if (replaceFromName.trim()) {
                    // Field has text: replace the display name with new name
                    finalHeaderValue = `${replaceFromName} <${emailPart}>`;
                  } else {
                    // Field is empty: remove display name, keep only email
                    finalHeaderValue = emailPart;
                  }
                } else {
                  // Format: just email address or <email@domain.com>
                  const emailOnly = finalHeaderValue.replace(/^<|>$/g, '').trim();
                  if (replaceFromName.trim()) {
                    // Add display name to plain email
                    finalHeaderValue = `${replaceFromName} <${emailOnly}>`;
                  }
                  // If replaceFromName is empty, keep as is (plain email)
                }
              }

              if (headerName === 'message-id' && replaceMessageIdPrefix) {
                const messageIdMatch = finalHeaderValue.match(/^<([^@]+)(@.*)>$/);
                if (messageIdMatch) {
                  const beforeAt = messageIdMatch[1];
                  const afterAt = messageIdMatch[2];

                  if (messageIdPrefixPosition === 'start') {
                    finalHeaderValue = `<${replaceMessageIdPrefix}${beforeAt}${afterAt}>`;
                  } else {
                    finalHeaderValue = `<${beforeAt}${replaceMessageIdPrefix}${afterAt}>`;
                  }
                }
              }

              cleanedLines.push(`${headerMatch[1]}: ${finalHeaderValue}`);
            }
          } else {
            if (!skipCurrentHeader && cleanedLines.length > 0) {
              cleanedLines[cleanedLines.length - 1] += '\n' + line;
            }
          }
        } else {
          cleanedLines.push(line);
        }
      }

      if (replacementHeadersText) {
        const replacementLines = replacementHeadersText.split('\n');

        for (let i = replacementLines.length - 1; i >= 0; i--) {
          const line = replacementLines[i].trim();
          if (!line) continue;

          const headerMatch = line.match(/^([a-zA-Z0-9\-]+):\s*(.*)/);
          if (headerMatch) {
            const headerName = headerMatch[1];
            const headerValue = headerMatch[2];
            const headerNameLower = headerName.toLowerCase();

            let headerReplaced = false;
            for (let j = 0; j < cleanedLines.length; j++) {
              const existingHeaderMatch = cleanedLines[j].match(/^([a-zA-Z0-9\-]+):\s*(.*)/);
              if (existingHeaderMatch && existingHeaderMatch[1].toLowerCase() === headerNameLower) {
                cleanedLines[j] = `${headerName}: ${headerValue}`;
                headerReplaced = true;
                break;
              }
            }

            if (!headerReplaced) {
              const firstBodyLineIndex = cleanedLines.findIndex(line => line.trim() === '');
              const insertPosition = firstBodyLineIndex !== -1 ? firstBodyLineIndex : cleanedLines.length;
              cleanedLines.splice(insertPosition, 0, `${headerName}: ${headerValue}`);
            }
          }
        }
      }

      return cleanedLines.join('\n');
    }

    function addStatusLog(message, type = 'info') {
      const logEntry = document.createElement('div');
      logEntry.style.marginBottom = '0.25rem';

      if (type === 'success') {
        logEntry.style.color = '#10b981';
      } else if (type === 'error') {
        logEntry.style.color = '#ef4444';
      }

      logEntry.textContent = message;
      batchStatusLog.appendChild(logEntry);
      batchStatusLog.scrollTop = batchStatusLog.scrollHeight;
    }

    async function exportBatchAsZip() {
      if (processedBatchResults.length === 0) {
        showToast('No processed files to export', true);
        return;
      }

      try {
        const zip = new JSZip();
        const folder = zip.folder('cleaned_emails');

        processedBatchResults.forEach(result => {
          folder.file(result.filename, result.content);
        });

        const blob = await zip.generateAsync({ type: 'blob' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `cleaned_emails_${new Date().getTime()}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast(`Exported ${processedBatchResults.length} files as ZIP!`);
      } catch (error) {
        console.error('Error creating zip:', error);
        showToast('Error creating ZIP file', true);
      }
    }

    // Header Removal Modal Events
    addCustomHeaderBtn.addEventListener('click', () => {
      const header = customHeaderInput.value.trim();
      if (header) {
        customHeaders.push(header);
        customHeaderInput.value = '';
        saveHeaderSettings();
        initCustomHeaderCheckboxes();
        showToast(`Added custom header: ${header}`);
      }
    });

    selectAllHeadersBtn.addEventListener('click', () => {
      const checkboxes = headerCheckboxList.querySelectorAll('input[type="checkbox"]');
      const customCheckboxes = customHeaderCheckboxList.querySelectorAll('input[type="checkbox"]');

      checkboxes.forEach(cb => cb.checked = true);
      customCheckboxes.forEach(cb => cb.checked = true);

      updateHeadersToRemove();
    });

    clearAllHeadersBtn.addEventListener('click', () => {
      const checkboxes = headerCheckboxList.querySelectorAll('input[type="checkbox"]');
      const customCheckboxes = customHeaderCheckboxList.querySelectorAll('input[type="checkbox"]');

      checkboxes.forEach(cb => cb.checked = false);
      customCheckboxes.forEach(cb => cb.checked = false);

      updateHeadersToRemove();
    });

    // Radio button event listeners
    document.querySelectorAll('input[name="messageIdPosition"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        messageIdPrefixPosition = e.target.value;
        saveReplacementHeaders();
      });
    });

    // Replacement Headers Modal Events
    applyReplacementHeadersBtn.addEventListener('click', () => {
      replacementHeadersText = replacementHeadersTextarea.value;
      replaceSubject = replaceSubjectInput.value;
      replaceFromDomain = replaceFromDomainInput.value;
      replaceFromEmail = replaceFromEmailInput.value; // Get from email
      replaceFromEmailEnabled = replaceFromEmailEnabledInput.checked; // Get from email enabled state
      replaceFromName = replaceFromNameInput.value; // Get from name
      replaceFromNameEnabled = replaceFromNameEnabledInput.checked; // Get from name enabled state

      // Get selected radio button value
      const selectedRadio = document.querySelector('input[name="messageIdPosition"]:checked');
      if (selectedRadio) {
        messageIdPrefixPosition = selectedRadio.value;
      }

      saveReplacementHeaders();
      showToast('Replacement headers saved!');
      replacementHeadersModal.classList.remove('active');
    });

    clearReplacementHeadersBtn.addEventListener('click', () => {
      replacementHeadersTextarea.value = '';
      replaceSubjectInput.value = '';
      replaceFromDomainInput.value = '';
      replaceFromEmailInput.value = ''; // Clear from email
      replaceFromEmailEnabledInput.checked = false; // Clear from email enabled state
      replaceFromNameInput.value = ''; // Clear from name
      replaceFromNameEnabledInput.checked = false; // Clear from name enabled state

      replacementHeadersText = '';
      replaceSubject = '';
      replaceFromDomain = '';
      replaceFromEmail = ''; // Clear from email
      replaceFromEmailEnabled = false; // Clear from email enabled state
      replaceFromName = ''; // Clear from name
      replaceFromNameEnabled = false; // Clear from name enabled state
      replaceMessageIdPrefix = '';
      messageIdPrefixPosition = 'beforeAt'; // Reset to default

      // Reset radio buttons
      const radioButtons = document.querySelectorAll('input[name="messageIdPosition"]');
      radioButtons.forEach(radio => {
        radio.checked = radio.value === 'beforeAt';
      });

      saveReplacementHeaders();
      showToast('Replacement headers cleared!');
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        cleanEmail();
      }
    });

    // Close modals when clicking outside
    window.addEventListener('click', (e) => {
      if (e.target === headerRemovalModal) {
        headerRemovalModal.classList.remove('active');
      }
      if (e.target === replacementHeadersModal) {
        replacementHeadersModal.classList.remove('active');
      }
      if (e.target === projectManagerModal) {
        projectManagerModal.classList.remove('active');
      }
      if (e.target === themeModal) {
        themeModal.classList.remove('active');
      }
      if (e.target === batchUploadModal) {
        batchUploadModal.classList.remove('active');
      }
      if (e.target === smartInsertModal) {
        smartInsertModal.classList.remove('active');
      }
    });

    // Initialize
    function init() {
      initTheme();
      loadHeaderSettings();
      initHeaderCheckboxes();
      initCustomHeaderCheckboxes();
      loadReplacementHeaders();
      loadSavedProjects();
      updateStats();

      inputEl.addEventListener('input', updateStats);
    }

    init();
  </script>
</body>
</html>
