<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML Viewer Pro</title>
    <link rel="icon" type="image/svg+xml" href="https://cdn.qwenlm.ai/output/29483eff-0b49-44cd-820b-7d21f4df3db8/t2i/81e0c8a0-3b7f-4fd2-a886-8d5276e46979/1762106292.png?key=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyZXNvdXJjZV91c2VyX2lkIjoiMjk0ODNlZmYtMGI0OS00NGNkLTgyMGItN2QyMWY0ZGYzZGI4IiwicmVzb3VyY2VfaWQiOiIxNzYyMTA2MjkyIiwicmVzb3VyY2VfY2hhdF9pZCI6ImM0ODJkNGQ4LWYxZmItNGYxNy1iMGU0LTZkYmM1MGMxOTMxMyJ9.D-7-2uIcjyFALTovtW7WlJNxrs4iwdIn-jy7C7aSiKQ&x-oss-process=image/resize,m_mfit,w_450,h_450" />

    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/eclipse.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.css">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closetag.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchtags.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/xml-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/html-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/css-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/javascript-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/search.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.js"></script>
    <!-- Utilities -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify-html.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --danger: #ef4444;
            --success: #10b981;
            --dark-bg: #1e1e1e;
            --dark-header: #252526;
            --dark-border: #3e3e42;
            --light-bg: #ffffff;
            --light-header: #f9fafb;
            --light-border: #e5e7eb;
            --text-dark: #111827;
            --text-light: #f9fafb;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --radius: 8px;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--dark-bg);
            color: var(--text-light);
            overflow: hidden;
        }
        body.light-theme {
            background: var(--light-bg);
            color: var(--text-dark);
        }
        .header {
            background: var(--dark-header);
            padding: 12px 20px;
            border-bottom: 2px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            flex-shrink: 0;
        }
        body.light-theme .header {
            background: var(--light-header);
            border-bottom: 2px solid var(--primary);
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 1.25rem;
        }
        .logo i {
            color: var(--primary);
        }
        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .btn-group {
            display: flex;
            gap: 6px;
            background: rgba(255,255,255,0.05);
            padding: 4px;
            border-radius: 6px;
            align-items: center;
        }
        body.light-theme .btn-group {
            background: #f3f4f6;
        }
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        button:hover {
            background: var(--primary-dark);
        }
        button.secondary {
            background: #555;
        }
        button.secondary:hover {
            background: #666;
        }
        button.danger {
            background: var(--danger);
        }
        button.danger:hover {
            background: #dc2626;
        }
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .editor-section, .preview-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        .editor-section {
            border-right: 1px solid var(--dark-border);
        }
        body.light-theme .editor-section {
            border-right: 1px solid var(--light-border);
        }
        .section-header {
            background: var(--dark-header);
            padding: 10px 16px;
            border-bottom: 1px solid var(--dark-border);
            font-size: 14px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        body.light-theme .section-header {
            background: #f3f4f6;
            border-bottom: 1px solid var(--light-border);
            color: var(--text-dark);
        }
        .section-actions {
            display: flex;
            gap: 8px;
        }
        .CodeMirror {
            height: 100% !important;
            font-size: 14px;
            font-family: 'Consolas', 'Monaco', monospace;
            flex: 1;
        }
        .preview-wrapper {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            background: #f0f0f0;
            padding: 20px;
            overflow: auto;
        }
        body.light-theme .preview-wrapper {
            background: #f9fafb;
        }
        .preview-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        .preview-wrapper.mobile .preview-frame { max-width: 375px; }
        .preview-wrapper.iphone .preview-frame { max-width: 390px; }
        .preview-wrapper.tablet .preview-frame { max-width: 768px; }
        .preview-wrapper.ipad .preview-frame { max-width: 820px; }
        .preview-wrapper.laptop .preview-frame { max-width: 1366px; }
        .device-selector {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .device-btn {
            background: transparent;
            color: #ccc;
            border: 1px solid #555;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }
        body.light-theme .device-btn {
            color: #666;
            border-color: #ccc;
        }
        .device-btn:hover {
            background: #333;
        }
        body.light-theme .device-btn:hover {
            background: #e5e7eb;
        }
        .device-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: var(--radius);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            max-width: 90%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            font-size: 18px;
            font-weight: 600;
        }
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        /* Encoding textareas */
        .encoding-textarea {
            width: 100%;
            min-height: 120px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
        }
        .encoding-section {
            margin-bottom: 20px;
        }
        .encoding-section h4 {
            margin: 10px 0;
            color: #333;
        }
        .encoding-buttons {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        /* Status Bar */
        .status-bar {
            background: var(--dark-header);
            padding: 6px 16px;
            font-size: 12px;
            color: #aaa;
            display: flex;
            justify-content: space-between;
            flex-shrink: 0;
        }
        body.light-theme .status-bar {
            background: #f3f4f6;
            color: #666;
        }
        /* File Upload */
        .file-upload-container {
            position: relative;
            display: inline-block;
        }
        .file-upload-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        /* Auto-preview indicator */
        .auto-preview-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--success);
            margin-left: 10px;
        }
        .auto-preview-indicator i {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        /* Inspect Mode */
        .inspect-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 15px;
            font-size: 12px;
        }
        .inspect-toggle-btn {
            background: transparent;
            color: #ccc;
            border: 1px solid #555;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }
        body.light-theme .inspect-toggle-btn {
            color: #666;
            border-color: #ccc;
        }
        .inspect-toggle-btn:hover {
            background: #333;
        }
        body.light-theme .inspect-toggle-btn:hover {
            background: #e5e7eb;
        }
        .inspect-toggle-btn.active {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        .inspect-highlight {
            outline: 2px solid #4f46e5 !important;
            background-color: rgba(79, 70, 229, 0.1) !important;
            cursor: pointer !important;
        }
        .inspect-edit-modal {
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            padding: 10px;
            min-width: 200px;
        }
        .inspect-edit-textarea {
            width: 100%;
            min-height: 80px;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }
        .inspect-edit-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            justify-content: flex-end;
        }
        /* Responsive */
        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }
            .editor-section {
                border-right: none;
                border-bottom: 1px solid var(--dark-border);
                max-height: 45vh;
            }
            body.light-theme .editor-section {
                border-bottom: 1px solid var(--light-border);
            }
        }
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: stretch;
            }
            .logo {
                justify-content: center;
            }
            .controls {
                justify-content: center;
            }
        }
        
        /* Custom styles for the encoding modal */
        #encodingModal .modal-content {
            width: 800px;
            height: 800px;
            max-width: 800px;
            max-height: 800px;
        }
        
        #encodingModal .modal-body {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        #encodingModal .encoding-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        #encodingModal .encoding-textarea {
            flex: 1;
            min-height: 200px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <i class="fas fa-code"></i>
            <span>HTML Viewer Pro</span>
        </div>
        <div class="controls">
            <div class="btn-group">
                <button onclick="toggleTheme()"><i class="fas fa-moon"></i> Theme</button>
                <button onclick="openEncodingModal()"><i class="fas fa-key"></i> Encode</button>
            </div>
            <div class="btn-group">
                <button onclick="formatCode()"><i class="fas fa-magic"></i> Format</button>
                <div class="file-upload-container">
                    <button><i class="fas fa-upload"></i> Upload</button>
                    <input type="file" id="fileUpload" class="file-upload-input" accept=".html,.htm,.txt" onchange="handleFileUpload(event)">
                </div>
                <button onclick="showExportOptions()"><i class="fas fa-download"></i> Export</button>
                <button class="danger" onclick="clearCode()"><i class="fas fa-trash"></i> Clear</button>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="editor-section">
            <div class="section-header">
                <span><i class="fas fa-edit"></i> HTML Editor</span>
                <div class="section-actions">
                    <button onclick="findText()"><i class="fas fa-search"></i> Find</button>
                    <button onclick="replaceText()"><i class="fas fa-exchange-alt"></i> Replace</button>
                </div>
            </div>
            <textarea id="htmlCode"></textarea>
        </div>
        <div class="preview-section">
            <div class="section-header">
                <span><i class="fas fa-eye"></i> Preview</span>
                <div style="display: flex; align-items: center;">
                    <div class="auto-preview-indicator">
                        <i class="fas fa-circle"></i>
                        <span>Auto Preview</span>
                    </div>
                    <div class="inspect-toggle">
                        <span>Inspect:</span>
                        <button class="inspect-toggle-btn" id="inspectToggle" onclick="toggleInspectMode()">Off</button>
                    </div>
                    <div class="device-selector">
                        <button class="device-btn active" onclick="setDevice('desktop')">Desktop</button>
                        <button class="device-btn" onclick="setDevice('laptop')">Laptop</button>
                        <button class="device-btn" onclick="setDevice('tablet')">Tablet</button>
                        <button class="device-btn" onclick="setDevice('mobile')">Mobile</button>
                    </div>
                </div>
            </div>
            <div class="preview-wrapper" id="previewWrapper">
                <iframe id="preview" class="preview-frame"></iframe>
            </div>
        </div>
    </div>
    <div class="status-bar">
        <span id="statusLine">Line: 1, Column: 1</span>
        <span id="statusChars">Chars: 0</span>
    </div>

    <!-- Modals -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">ðŸ’¾ Export Options</div>
            <div class="modal-body">
                <div style="display: grid; gap: 12px;">
                    <button onclick="exportHTML()"><i class="fas fa-file-code"></i> Download HTML</button>
                    <button onclick="exportScreenshot()"><i class="fas fa-camera"></i> Save Screenshot</button>
                    <button onclick="exportCodePen()"><i class="fab fa-codepen"></i> Open in CodePen</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="secondary" onclick="closeModal('exportModal')">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="encodingModal">
        <div class="modal-content">
            <div class="modal-header">ðŸ”§ Encoding Tools</div>
            <div class="modal-body">
                <div class="encoding-section">
                    <h4>Base64</h4>
                    <textarea class="encoding-textarea" id="base64Input" placeholder="Enter text..."></textarea>
                    <div class="encoding-buttons">
                        <button onclick="encodeBase64()">Encode</button>
                        <button onclick="decodeBase64()">Decode</button>
                    </div>
                    <textarea class="encoding-textarea" id="base64Output" readonly></textarea>
                </div>
                <div class="encoding-section">
                    <h4>Quoted-Printable</h4>
                    <textarea class="encoding-textarea" id="qpInput" placeholder="Enter text..."></textarea>
                    <div class="encoding-buttons">
                        <button onclick="encodeQP()">Encode</button>
                        <button onclick="decodeQP()">Decode</button>
                    </div>
                    <textarea class="encoding-textarea" id="qpOutput" readonly></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="secondary" onclick="closeModal('encodingModal')">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize editor
        let editor = CodeMirror.fromTextArea(document.getElementById('htmlCode'), {
            mode: 'htmlmixed',
            theme: 'monokai',
            lineNumbers: true,
            autoCloseTags: true,
            matchTags: {bothTags: true},
            foldGutter: true,
            gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
            extraKeys: {
                'Ctrl-Space': 'autocomplete',
                'Ctrl-Shift-F': formatCode,
                'Cmd-Shift-F': formatCode,
                'Ctrl-F': findText,
                'Cmd-F': findText,
                'Ctrl-H': replaceText,
                'Cmd-H': replaceText,
                'Ctrl-/': 'toggleComment',
                'Cmd-/': 'toggleComment'
            },
            lineWrapping: true
        });

        // Default code
        const defaultCode = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 500px;
        }
        h1 { color: #667eea; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Welcome to HTML Viewer Pro! ðŸŽ‰</h1>
        <p>Start editing to see real-time preview.</p>
    </div>
</body>
</html>`;
        editor.setValue(defaultCode);

        // DOM elements
        const preview = document.getElementById('preview');
        let inspectMode = false;
        let currentHighlightedElement = null;
        let currentEditModal = null;

        // Update status bar
        editor.on('cursorActivity', () => {
            const cursor = editor.getCursor();
            document.getElementById('statusLine').textContent = 
                `Line: ${cursor.line + 1}, Column: ${cursor.ch + 1}`;
            document.getElementById('statusChars').textContent = 
                `Chars: ${editor.getValue().length}`;
        });

        // Auto-preview functionality
        let previewTimeout;
        editor.on('change', () => {
            // Clear existing timeout
            if (previewTimeout) {
                clearTimeout(previewTimeout);
            }
            
            // Set new timeout to update preview after a short delay
            previewTimeout = setTimeout(updatePreview, 300);
        });

        function updatePreview() {
            const code = editor.getValue();
            try {
                const doc = preview.contentDocument || preview.contentWindow.document;
                doc.open();
                doc.write(code);
                doc.close();
                
                // Re-attach inspect mode event listeners if inspect mode is active
                if (inspectMode) {
                    setTimeout(attachInspectListeners, 100);
                }
            } catch (e) {
                // Silently handle errors for auto-preview
                console.error('Preview update error:', e);
            }
        }

        // Inspect Mode Functions
        function toggleInspectMode() {
            inspectMode = !inspectMode;
            const toggleBtn = document.getElementById('inspectToggle');
            
            if (inspectMode) {
                toggleBtn.textContent = 'On';
                toggleBtn.classList.add('active');
                attachInspectListeners();
            } else {
                toggleBtn.textContent = 'Off';
                toggleBtn.classList.remove('active');
                removeInspectListeners();
                removeHighlight();
                removeEditModal();
            }
        }

        function attachInspectListeners() {
            try {
                const doc = preview.contentDocument || preview.contentWindow.document;
                if (!doc || !doc.body) return;
                
                // Remove existing listeners first
                removeInspectListeners();
                
                // Add mouseover and click listeners to all elements
                const allElements = doc.querySelectorAll('*');
                allElements.forEach(element => {
                    element.addEventListener('mouseover', handleElementMouseOver);
                    element.addEventListener('mouseout', handleElementMouseOut);
                    element.addEventListener('click', handleElementClick);
                });
            } catch (e) {
                console.error('Error attaching inspect listeners:', e);
            }
        }

        function removeInspectListeners() {
            try {
                const doc = preview.contentDocument || preview.contentWindow.document;
                if (!doc || !doc.body) return;
                
                const allElements = doc.querySelectorAll('*');
                allElements.forEach(element => {
                    element.removeEventListener('mouseover', handleElementMouseOver);
                    element.removeEventListener('mouseout', handleElementMouseOut);
                    element.removeEventListener('click', handleElementClick);
                });
            } catch (e) {
                console.error('Error removing inspect listeners:', e);
            }
        }

        function handleElementMouseOver(e) {
            e.stopPropagation();
            removeHighlight();
            currentHighlightedElement = e.target;
            currentHighlightedElement.classList.add('inspect-highlight');
        }

        function handleElementMouseOut(e) {
            e.stopPropagation();
            if (currentHighlightedElement === e.target) {
                removeHighlight();
            }
        }

        function handleElementClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (currentHighlightedElement) {
                showEditModal(currentHighlightedElement);
            }
        }

        function removeHighlight() {
            if (currentHighlightedElement) {
                currentHighlightedElement.classList.remove('inspect-highlight');
                currentHighlightedElement = null;
            }
        }

        function showEditModal(element) {
            removeEditModal();
            
            const rect = element.getBoundingClientRect();
            const iframeRect = preview.getBoundingClientRect();
            
            currentEditModal = document.createElement('div');
            currentEditModal.className = 'inspect-edit-modal';
            currentEditModal.style.left = (rect.left + iframeRect.left) + 'px';
            currentEditModal.style.top = (rect.bottom + iframeRect.top + 5) + 'px';
            
            const textarea = document.createElement('textarea');
            textarea.className = 'inspect-edit-textarea';
            textarea.value = element.textContent || element.innerHTML || '';
            
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'inspect-edit-buttons';
            
            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'Save';
            saveBtn.onclick = () => saveElementContent(element, textarea.value);
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.className = 'secondary';
            cancelBtn.onclick = removeEditModal;
            
            buttonContainer.appendChild(cancelBtn);
            buttonContainer.appendChild(saveBtn);
            
            currentEditModal.appendChild(textarea);
            currentEditModal.appendChild(buttonContainer);
            
            document.body.appendChild(currentEditModal);
            
            // Focus the textarea
            textarea.focus();
            
            // Close modal when clicking outside
            setTimeout(() => {
                document.addEventListener('click', handleOutsideClick, true);
            }, 100);
        }

        function handleOutsideClick(e) {
            if (currentEditModal && !currentEditModal.contains(e.target) && e.target !== currentHighlightedElement) {
                removeEditModal();
            }
        }

        function removeEditModal() {
            if (currentEditModal) {
                document.body.removeChild(currentEditModal);
                currentEditModal = null;
                document.removeEventListener('click', handleOutsideClick, true);
            }
        }

        function saveElementContent(element, newContent) {
            if (element.textContent !== undefined) {
                element.textContent = newContent;
            } else {
                element.innerHTML = newContent;
            }
            removeEditModal();
            removeHighlight();
            
            // Update the editor with the modified content
            const doc = preview.contentDocument || preview.contentWindow.document;
            const newHtml = doc.documentElement.outerHTML;
            editor.setValue(newHtml);
        }

        // File upload function
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.html') && !fileName.endsWith('.htm') && !fileName.endsWith('.txt')) {
                alert('Please upload an HTML file (.html, .htm) or text file (.txt)');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                editor.setValue(content);
                // Preview will update automatically due to the change event
            };
            reader.onerror = function() {
                alert('Error reading file');
            };
            reader.readAsText(file);
            
            // Reset the file input
            event.target.value = '';
        }

        // Theme toggle
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            const isLight = document.body.classList.contains('light-theme');
            editor.setOption('theme', isLight ? 'eclipse' : 'monokai');
        }

        // Device preview
        function setDevice(device) {
            document.querySelectorAll('.device-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('previewWrapper').className = 'preview-wrapper ' + device;
        }

        // Export functions
        function exportHTML() {
            const blob = new Blob([editor.getValue()], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'page.html';
            a.click();
            URL.revokeObjectURL(url);
            closeModal('exportModal');
        }

        function exportScreenshot() {
            html2canvas(preview.contentDocument.body).then(canvas => {
                const link = document.createElement('a');
                link.download = 'screenshot.png';
                link.href = canvas.toDataURL();
                link.click();
                closeModal('exportModal');
            }).catch(e => {
                alert('Screenshot failed: ' + e.message);
            });
        }

        function exportCodePen() {
            const code = editor.getValue();
            const html = code.match(/<body[^>]*>([\s\S]*)<\/body>/i)?.[1] || code;
            const css = code.match(/<style[^>]*>([\s\S]*)<\/style>/i)?.[1] || '';
            const js = code.match(/<script[^>]*>([\s\S]*?)<\/script>/i)?.[1] || '';
            
            const form = document.createElement('form');
            form.action = 'https://codepen.io/pen/define';
            form.method = 'POST';
            form.target = '_blank';
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'data';
            input.value = JSON.stringify({html, css, js});
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
            closeModal('exportModal');
        }

        // Formatting
        function formatCode() {
            try {
                const formatted = html_beautify(editor.getValue(), { indent_size: 2 });
                editor.setValue(formatted);
                // Preview will update automatically due to the change event
            } catch (e) {
                alert('Formatting failed: ' + e.message);
            }
        }

        // Base64 Encoding
        function encodeBase64() {
            try {
                const input = document.getElementById('base64Input').value;
                document.getElementById('base64Output').value = btoa(unescape(encodeURIComponent(input)));
            } catch (e) {
                document.getElementById('base64Output').value = 'Error: ' + e.message;
            }
        }

        function decodeBase64() {
            try {
                const input = document.getElementById('base64Input').value;
                document.getElementById('base64Output').value = decodeURIComponent(escape(atob(input)));
            } catch (e) {
                document.getElementById('base64Output').value = 'Error: ' + e.message;
            }
        }

        // Quoted-Printable Encoding
        function encodeQP() {
            try {
                const input = document.getElementById('qpInput').value;
                document.getElementById('qpOutput').value = quotedPrintableEncode(input);
            } catch (e) {
                document.getElementById('qpOutput').value = 'Error: ' + e.message;
            }
        }

        function decodeQP() {
            try {
                const input = document.getElementById('qpInput').value;
                document.getElementById('qpOutput').value = quotedPrintableDecode(input);
            } catch (e) {
                document.getElementById('qpOutput').value = 'Error: ' + e.message;
            }
        }

        // Quoted-Printable Implementation
        function quotedPrintableEncode(str) {
            // Convert to UTF-8 bytes
            const utf8Bytes = new TextEncoder().encode(str);
            let result = '';
            
            for (let i = 0; i < utf8Bytes.length; i++) {
                const byte = utf8Bytes[i];
                
                // Check if character needs encoding
                if ((byte >= 33 && byte <= 60) || (byte >= 62 && byte <= 126) || byte === 32) {
                    // Printable ASCII character (excluding =)
                    result += String.fromCharCode(byte);
                } else if (byte === 61) {
                    // Equal sign must be encoded
                    result += '=3D';
                } else if (byte === 9) {
                    // Tab
                    result += '\t';
                } else if (byte === 32 && (i === utf8Bytes.length - 1 || utf8Bytes[i + 1] === 10 || utf8Bytes[i + 1] === 13)) {
                    // Space at end of line must be encoded
                    result += '=20';
                } else {
                    // Non-printable character
                    result += '=' + byte.toString(16).toUpperCase().padStart(2, '0');
                }
                
                // Soft line breaks every 76 characters (excluding the = at the end)
                if (result.length > 0 && (result.length - result.lastIndexOf('\n') - 1) >= 75) {
                    result += '=\n';
                }
            }
            
            return result;
        }

        function quotedPrintableDecode(str) {
            let result = '';
            let i = 0;
            
            while (i < str.length) {
                const char = str[i];
                
                if (char === '=') {
                    // Check if this is a soft line break
                    if (i + 1 < str.length && (str[i + 1] === '\r' || str[i + 1] === '\n')) {
                        // Soft line break - skip the = and the line break
                        i += 2;
                        if (str[i - 1] === '\r' && i < str.length && str[i] === '\n') {
                            i++; // Skip \n after \r
                        }
                        continue;
                    }
                    
                    // Regular encoded character
                    if (i + 2 < str.length) {
                        const hex = str.substring(i + 1, i + 3);
                        if (/^[0-9A-Fa-f]{2}$/.test(hex)) {
                            result += String.fromCharCode(parseInt(hex, 16));
                            i += 3;
                            continue;
                        }
                    }
                    
                    // If we get here, it's an invalid encoding
                    result += char;
                    i++;
                } else {
                    result += char;
                    i++;
                }
            }
            
            // Convert from UTF-8 bytes to string
            const bytes = new Uint8Array(result.length);
            for (let j = 0; j < result.length; j++) {
                bytes[j] = result.charCodeAt(j);
            }
            
            try {
                return new TextDecoder('utf-8').decode(bytes);
            } catch (e) {
                return result; // Fallback if UTF-8 decoding fails
            }
        }

        // Utility functions
        function findText() { editor.execCommand('find'); }
        function replaceText() { editor.execCommand('replace'); }
        function openEncodingModal() { document.getElementById('encodingModal').classList.add('active'); }
        function showExportOptions() { document.getElementById('exportModal').classList.add('active'); }
        function clearCode() {
            if (confirm('Clear all code?')) {
                editor.setValue('');
                preview.src = 'about:blank';
            }
        }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        // Close modals on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', e => {
                if (e.target === modal) closeModal(modal.id);
            });
        });

        // Initialize preview on load
        window.addEventListener('load', updatePreview);
    </script>
</body>
</html>
