<!DOCTYPE html>
<html lang="en" id="theme-root">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fluid Command Center | Enterprise Email Tools</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;utf8,%3Csvg%20width%3D%22200%22%20height%3D%22200%22%20viewBox%3D%220%200%20200%20200%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%20%20%3Cdefs%3E%0A%20%20%20%20%3ClinearGradient%20id%3D%22logoGradient%22%20x1%3D%220%25%22%20y1%3D%220%25%22%20x2%3D%22100%25%22%20y2%3D%22100%25%22%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%234338ca%22%3E%3C%2Fstop%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%237e22ce%22%3E%3C%2Fstop%3E%0A%20%20%20%20%3C%2FlinearGradient%3E%0A%20%20%3C%2Fdefs%3E%0A%0A%20%20%3Cpath%20d%3D%22M40%2060%20L160%2060%20L160%20140%20L40%20140%20Z%22%20fill%3D%22url(%23logoGradient)%22%3E%3C%2Fpath%3E%0A%20%20%3Cpath%20d%3D%22M40%2060%20L100%20100%20L160%2060%22%20fill%3D%22white%22%20opacity%3D%220.3%22%3E%3C%2Fpath%3E%0A%20%20%3Ccircle%20cx%3D%22100%22%20cy%3D%22100%22%20r%3D%2224%22%20fill%3D%22white%22%20opacity%3D%220.2%22%3E%3C%2Fcircle%3E%0A%20%20%3Cpath%20d%3D%22M60%2085%20L100%20110%20L140%2085%22%20stroke%3D%22white%22%20stroke-width%3D%226%22%20fill%3D%22none%22%20stroke-linecap%3D%22round%22%3E%3C%2Fpath%3E%0A%3C%2Fsvg%3E%0A" />

    <style>
        /* --- THEME DEFINITIONS --- */

        /* Light Theme (Default) */
        :root, #theme-root.light {
            --primary-500: #6366f1; /* Indigo */
            --secondary-500: #8b5cf6; /* Violet */
            --neutral-900: #0f172a; /* Slate */
            --bg-light: #e0eaff;
            --text-primary: var(--neutral-900);
            --text-secondary: #4b5563;
            --glass-bg: rgba(255, 255, 255, 0.5);
            --card-bg: rgba(255, 255, 255, 0.7);
            --border-color: rgba(0, 0, 0, 0.1);
            --icon-color: var(--primary-500);
            --shadow-glass: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            --shadow-hover: 0 12px 40px 0 rgba(31, 38, 135, 0.15);
            --bg-gradient: radial-gradient(circle at 10% 90%, #e0eaff 0%, transparent 40%),
                           radial-gradient(circle at 80% 20%, #eff6ff 0%, transparent 45%);
            --btn-primary-bg: var(--primary-500);
            --btn-primary-hover: #4f46e5;
        }

        /* Dark Theme */
        .dark {
            --primary-500: #8b5cf6; /* Violet */
            --secondary-500: #a78bfa; /* Lighter Violet */
            --neutral-900: #e2e8f0;
            --bg-light: #0d111d;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --glass-bg: rgba(30, 41, 59, 0.6);
            --card-bg: rgba(30, 41, 59, 0.8);
            --border-color: rgba(255, 255, 255, 0.1);
            --icon-color: var(--primary-500);
            --shadow-glass: 0 8px 32px 0 rgba(0, 0, 0, 0.25);
            --shadow-hover: 0 12px 40px 0 rgba(0, 0, 0, 0.4);
            --bg-gradient: radial-gradient(circle at 10% 90%, #1e3a8a 0%, transparent 40%),
                           radial-gradient(circle at 80% 20%, #4c1d95 0%, transparent 45%);
            --btn-primary-bg: var(--primary-500);
            --btn-primary-hover: #7c3aed;
        }

        /* New Theme 1: Solaris (Warm, Gold/Red) */
        .solaris {
            --primary-500: #f59e0b; /* Amber */
            --secondary-500: #ef4444; /* Red */
            --neutral-900: #1f2937; /* Dark Gray for text */
            --bg-light: #fffbeb; /* Creamy background */
            --text-primary: var(--neutral-900);
            --text-secondary: #6b7280;
            --glass-bg: rgba(255, 247, 237, 0.6);
            --card-bg: rgba(255, 250, 240, 0.8);
            --border-color: rgba(245, 158, 11, 0.2);
            --icon-color: var(--primary-500);
            --shadow-glass: 0 8px 32px 0 rgba(245, 158, 11, 0.1);
            --shadow-hover: 0 12px 40px 0 rgba(245, 158, 11, 0.15);
            --bg-gradient: radial-gradient(circle at 10% 90%, #fef3c7 0%, transparent 40%),
                           radial-gradient(circle at 80% 20%, #fde68a 0%, transparent 45%);
            --btn-primary-bg: var(--primary-500);
            --btn-primary-hover: #d97706;
        }

        /* New Theme 2: Midnight (Deep, Cyan/Teal) */
        .midnight {
            --primary-500: #06b6d4; /* Cyan */
            --secondary-500: #14b8a6; /* Teal */
            --neutral-900: #e2e8f0;
            --bg-light: #000a12; /* Near black */
            --text-primary: #e2e8f0;
            --text-secondary: #64748b;
            --glass-bg: rgba(6, 182, 212, 0.08); /* Faint cyan tint */
            --card-bg: rgba(15, 23, 42, 0.9); /* Darker card */
            --border-color: rgba(6, 182, 212, 0.2);
            --icon-color: var(--primary-500);
            --shadow-glass: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
            --shadow-hover: 0 12px 40px 0 rgba(0, 0, 0, 0.6);
            --bg-gradient: radial-gradient(circle at 10% 90%, #083344 0%, transparent 40%),
                           radial-gradient(circle at 80% 20%, #0f766e 0%, transparent 45%);
            --btn-primary-bg: var(--primary-500);
            --btn-primary-hover: #0891b2;
        }

        /* --- GLOBAL & COMMON STYLES --- */
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            background-color: var(--bg-light);
            transition: all 0.5s ease; /* Increased transition time for themes */
        }
        
        /* Transition utility variable */
        :root { --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Dynamic Background Effect */
        #background-effect {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-gradient); background-size: 200% 200%;
            animation: gradient-shift 60s ease infinite; z-index: -1; opacity: 0.7;
        }
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Main Layout & Sidebar */
        .main-layout { display: flex; width: 100%; }
        :root { --sidebar-width: 280px; }
        .sidebar {
            width: var(--sidebar-width); min-height: 100vh; padding: 30px 20px;
            background: var(--glass-bg); border-right: 1px solid var(--border-color);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            box-shadow: var(--shadow-glass); display: flex; flex-direction: column;
            justify-content: space-between; position: sticky; top: 0; transition: var(--transition);
        }
        .logo-container { display: flex; align-items: center; gap: 12px; margin-bottom: 40px; }
        .logo { width: 32px; height: 32px; flex-shrink: 0; }
        
        /* Gradient text dependent on theme variables */
        .logo-text {
            font-size: 1.5rem; font-weight: 800; letter-spacing: -0.025em;
            background: linear-gradient(to right, var(--primary-500), var(--secondary-500));
            -webkit-background-clip: text; background-clip: text; color: transparent;
        }
        
        .nav-link {
            display: flex; align-items: center; gap: 16px; padding: 14px 20px;
            border-radius: 10px; color: var(--text-secondary); text-decoration: none;
            font-weight: 600; margin-bottom: 8px; transition: var(--transition);
        }
        
        /* Dynamic Nav Link Hover/Active based on theme */
        .nav-link.active,
        .nav-link:hover {
            color: var(--primary-500);
            box-shadow: 0 2px 4px color-mix(in srgb, var(--primary-500) 20%, transparent);
        }
        
        /* Theme-specific background for active/hover state */
        .light .nav-link:hover, .light .nav-link.active { background: rgba(99, 102, 241, 0.1); }
        .dark .nav-link:hover, .dark .nav-link.active { background: rgba(139, 92, 246, 0.15); }
        .solaris .nav-link:hover, .solaris .nav-link.active { background: rgba(245, 158, 11, 0.15); }
        .midnight .nav-link:hover, .midnight .nav-link.active { background: rgba(6, 182, 212, 0.15); }

        .nav-link svg { width: 20px; height: 20px; stroke-width: 2; }
        .sidebar-footer { padding-top: 20px; border-top: 1px solid var(--border-color); }

        /* Dashboard Content Area */
        .dashboard-content { flex-grow: 1; padding: 40px; min-width: 0; }
        .dashboard-header { margin-bottom: 40px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .welcome-title { font-size: 2.25rem; font-weight: 700; letter-spacing: -0.025em; }
        .welcome-subtitle { color: var(--text-secondary); font-size: 1.125rem; }
        .quick-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card {
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 14px; padding: 20px;
            box-shadow: var(--shadow-glass); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            transition: var(--transition); cursor: default;
        }
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); border-color: var(--primary-500); }
        
        /* Gradient text dependent on theme variables */
        .stat-value {
            font-size: 2.5rem; font-weight: 800; line-height: 1; margin-bottom: 8px;
            background: linear-gradient(90deg, var(--primary-500), var(--secondary-500));
            -webkit-background-clip: text; background-clip: text; color: transparent;
        }
        
        .stat-label { font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); }
        .tools-grid-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 30px; }

        /* Interactive Tool Card */
        .tool-widget {
            background: var(--card-bg); border-radius: 14px; padding: 30px; box-shadow: var(--shadow-glass);
            border: 1px solid var(--border-color); transition: var(--transition); text-decoration: none;
            color: inherit; display: flex; flex-direction: column; justify-content: space-between;
            height: 100%; position: relative; cursor: pointer;
        }
        .tool-widget:hover { transform: translateY(-4px); box-shadow: var(--shadow-hover); border-color: var(--primary-500); }
        .widget-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .widget-icon-wrapper {
            display: flex; align-items: center; justify-content: center; width: 48px; height: 48px;
            border-radius: 12px; background: var(--icon-color); color: white; flex-shrink: 0;
        }
        .widget-icon-wrapper svg { width: 24px; height: 24px; stroke-width: 2; }
        .tool-title { font-size: 1.5rem; font-weight: 700; line-height: 1.3; }
        .tool-description { color: var(--text-secondary); font-size: 1rem; margin-bottom: 20px; }
        .tool-badge {
            display: inline-block; background: linear-gradient(90deg, var(--primary-500), var(--secondary-500));
            color: white; padding: 0.35rem 1rem; border-radius: 9999px; font-size: 0.85rem; font-weight: 600;
            letter-spacing: 0.05em; text-transform: uppercase; box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
        }
        
        /* General Button Style */
        .btn {
            padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;
            transition: var(--transition); display: inline-flex; align-items: center; justify-content: center;
            gap: 8px; border: none;
        }
        .btn-primary {
            background-color: var(--btn-primary-bg); color: white;
            box-shadow: 0 4px 10px color-mix(in srgb, var(--primary-500) 40%, transparent);
        }
        .btn-primary:hover {
            background-color: var(--btn-primary-hover);
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border-color);
        }
        .btn-secondary:hover {
            border-color: var(--primary-500);
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
            z-index: 100; transition: opacity 0.3s ease; opacity: 0; pointer-events: none;
        }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        .modal-content {
            background: var(--card-bg); border-radius: 16px; padding: 30px; width: 90%; max-width: 1000px;
            box-shadow: var(--shadow-hover); border: 1px solid var(--border-color);
            transform: scale(0.95); transition: transform 0.3s ease; max-height: 90vh; overflow-y: auto;
            display: grid; grid-template-columns: 1fr 1fr; gap: 30px;
        }
        .modal-overlay.open .modal-content { transform: scale(1); }
        .modal-header {
            grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px;
        }
        .modal-header h3 { font-size: 1.75rem; }
        .close-btn { background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--text-secondary); }

        /* Form Area Styles */
        textarea, select {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color);
            background: var(--glass-bg); color: var(--text-primary); font-family: inherit;
            transition: var(--transition); resize: vertical; min-height: 150px;
        }
        textarea:focus, select:focus {
            outline: none; border-color: var(--primary-500); box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary-500) 40%, transparent);
        }
        label { font-weight: 600; display: block; margin-bottom: 5px; color: var(--text-primary); }
        .input-group { margin-bottom: 20px; }
        
        /* Result Area Styles */
        .result-panel {
            min-height: 250px; padding: 15px; border-radius: 8px; border: 1px dashed var(--border-color);
            background: var(--glass-bg); color: var(--text-primary); font-size: 0.9rem;
            white-space: pre-wrap; word-wrap: break-word; line-height: 1.6;
        }
        .loading-indicator {
            text-align: center; color: var(--primary-500); font-style: italic;
        }
        
        /* --- THEME SELECTOR STYLES --- */
        .theme-selector {
            justify-content: space-around;
            padding: 10px 0;
        }
        .theme-option {
            width: 32px; height: 32px; border-radius: 9999px; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid transparent;
        }
        .theme-option:hover {
            transform: scale(1.05);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--text-primary) 50%, transparent);
        }
        .theme-option.active {
            border: 4px solid var(--text-primary);
            box-shadow: 0 0 0 2px var(--bg-light);
        }
        .light .theme-option.active, .solaris .theme-option.active {
             border: 4px solid var(--neutral-900); /* Dark Border on Light Backgrounds */
             box-shadow: 0 0 0 2px white;
        }
        .dark .theme-option.active, .midnight .theme-option.active {
             border: 4px solid var(--neutral-900); /* Light Border on Dark Backgrounds */
             box-shadow: 0 0 0 2px var(--bg-light);
        }
        
        /* Responsive Adjustments */
        @media (max-width: 1024px) {
            .sidebar { width: 200px; }
            .dashboard-content { padding: 30px 20px; }
        }
        @media (max-width: 768px) {
            .main-layout { flex-direction: column; }
            .sidebar { width: 100%; min-height: auto; padding: 20px 20px 0; position: static; border-right: none; border-bottom: 1px solid var(--border-color); }
            .sidebar-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
            .logo-container { margin-bottom: 0; }
            /* Show theme selector in the header for mobile */
            .sidebar-footer { display: flex; justify-content: center; align-items: center; padding: 10px 0; border: none; }
            .sidebar-footer > p.stat-label { display: none; } /* Hide label on mobile */
            .dashboard-content { padding: 20px; }
            .tools-grid-dashboard { grid-template-columns: 1fr; }
            .header-top { flex-direction: column; align-items: flex-start; gap: 10px; }
            .modal-content { grid-template-columns: 1fr; gap: 20px; }
        }
    </style>
</head>
<body>
    <!-- Dynamic Background Effect -->
    <div id="background-effect"></div>

    <!-- SVG Definitions -->
    <svg style="display:none">
        <!-- Main Logo (Email Icon) -->
        <symbol id="emailLogo" viewBox="0 0 200 200">
            <defs>
                <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stop-color="#4338ca" />
                    <stop offset="100%" stop-color="#7e22ce" />
                </linearGradient>
            </defs>
            <path d="M40 60 L160 60 L160 140 L40 140 Z" fill="url(#logoGradient)"/>
            <path d="M40 60 L100 100 L160 60" fill="white" opacity="0.3"/>
            <circle cx="100" cy="100" r="24" fill="white" opacity="0.2"/>
            <path d="M60 85 L100 110 L140 85" stroke="white" stroke-width="6" fill="none" stroke-linecap="round"/>
        </symbol>

        <!-- Tool Icons (Lucide-like) -->
        <symbol id="icon-process" viewBox="0 0 24 24">
            <path d="M3 14s.7-1.7 2.2-2.2c1.4-.4 2.8-.2 3.8.8l2 2c1 1 2.4 1.4 3.8.8 1.5-.5 2.2-2.2 2.2-2.2M14 6s-.7 1.7-2.2 2.2c-1.4.4-2.8.2-3.8-.8l-2-2c-1-1-2.4-1.4-3.8-.8-1.5.5-2.2 2.2-2.2 2.2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M17 17l4 4M21 17l-4 4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </symbol>
        <symbol id="icon-shield" viewBox="0 0 24 24">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 12a4 4 0 100-8 4 4 0 000 8z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </symbol>
        <symbol id="icon-scan" viewBox="0 0 24 24">
            <path d="M21 16v-2a2 2 0 00-2-2H5a2 2 0 00-2 2v2M21 8V6a2 2 0 00-2-2H5a2 2 0 00-2 2v2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 20v-4M12 12v-4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </symbol>
        <symbol id="icon-code" viewBox="0 0 24 24">
            <path d="M16 18l4-4-4-4M8 6l-4 4 4 4M12 3v2M12 19v2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </symbol>
        <symbol id="icon-sparkle" viewBox="0 0 24 24">
            <path d="M12 2v2M12 20v2M20 12h2M2 12h2M18.364 5.636l-.707.707M5.636 18.364l-.707.707M18.364 18.364l-.707-.707M5.636 5.636l-.707-.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </symbol>
    </svg>

    <div class="main-layout">
        <!-- Sidebar Navigation (Glassmorphism) -->
        <aside class="sidebar">
            <div class="sidebar-top">
                <div class="logo-container">
                    <svg class="logo"><use href="#emailLogo"></use></svg>
                    <h1 class="logo-text">Command Center</h1>
                </div>
                <!-- Theme Selector for Mobile (moved to footer for consistency) -->
            </div>

            <nav class="nav-menu">
                <a href="#" class="nav-link active">
                    <svg><use href="#icon-scan"></use></svg>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-link">
                    <svg><use href="#icon-process"></use></svg>
                    <span>List Processor</span>
                </a>
                <a href="#" class="nav-link" id="nav-mailguard-pro">
                    <svg><use href="#icon-shield"></use></svg>
                    <span>MailGuard Pro</span>
                </a>
                <a href="#" class="nav-link">
                    <svg><use href="#icon-code"></use></svg>
                    <span>HTML Inspector</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <p class="stat-label mb-3 hidden md:block">Theme Selector</p>
                <div class="theme-selector flex space-x-2">
                    <button data-theme="light" class="theme-option" style="background-color: #6366f1;" aria-label="Light Theme"></button>
                    <button data-theme="dark" class="theme-option" style="background-color: #8b5cf6;" aria-label="Dark Theme"></button>
                    <button data-theme="solaris" class="theme-option" style="background-color: #f59e0b;" aria-label="Solaris Theme"></button>
                    <button data-theme="midnight" class="theme-option" style="background-color: #06b6d4;" aria-label="Midnight Theme"></button>
                </div>
                <p class="text-xs text-center mt-3 text-secondary hidden md:block" id="current-theme-label">Current: Light</p>
            </div>
        </aside>

        <!-- Main Dashboard Content -->
        <main class="dashboard-content">
            <header class="dashboard-header">
                <div class="header-top">
                    <div>
                        <h2 class="welcome-title">Welcome, IT Manager</h2>
                        <p class="welcome-subtitle">Your enterprise email infrastructure, at a glance.</p>
                    </div>
                </div>

                <!-- Quick Stats Section (Immediate Context) -->
                <div class="quick-stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">850K</div>
                        <div class="stat-label">Records Processed (Last 24h)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">98.5%</div>
                        <div class="stat-label">DMARC Compliance Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value text-error-500">4</div>
                        <div class="stat-label">Security Alerts (High Priority)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">0.3s</div>
                        <div class="stat-label">Avg. Processing Latency</div>
                    </div>
                </div>
            </header>

            <!-- Tools Grid (Interactive Widgets) -->
            <section>
                <h3 class="welcome-title text-xl font-semibold mb-4 border-b border-border-color pb-2">Tools & Modules</h3>
                <div class="tools-grid-dashboard">
                    <a href="#" class="tool-widget">
                        <div class="widget-header">
                            <div class="widget-icon-wrapper" style="background: var(--primary-500);">
                                <svg><use href="#icon-process"></use></svg>
                            </div>
                            <h4 class="tool-title">Email List Processor</h4>
                        </div>
                        <p class="tool-description">Advanced deduplication, validation, and segmentation for enterprise email lists. Process millions of records with military-grade accuracy.</p>
                        <span class="tool-badge">Data Processing</span>
                    </a>

                    <!-- MailGuard Pro widget now opens the AI Modal -->
                    <div id="open-mailguard-modal" class="tool-widget">
                        <div class="widget-header">
                            <div class="widget-icon-wrapper" style="background: var(--secondary-500);">
                                <svg><use href="#icon-shield"></use></svg>
                            </div>
                            <h4 class="tool-title">MailGuard Pro: AI Refiner</h4>
                        </div>
                        <p class="tool-description">AI-powered email refinement and compliance checking. Scan drafts for PII risks and rewrite content instantly to match corporate tone.</p>
                        <span class="tool-badge">âœ¨ AI Compliance</span>
                    </div>

                    <a href="#" class="tool-widget">
                        <div class="widget-header">
                            <div class="widget-icon-wrapper" style="background: #10b981;">
                                <svg><use href="#icon-scan"></use></svg>
                            </div>
                            <h4 class="tool-title">Security Posture Scanner</h4>
                        </div>
                        <p class="tool-description">Comprehensive SPF, DKIM, and DMARC analysis with actionable remediation reports. Reduce phishing risk by 92%.</p>
                        <span class="tool-badge" style="background: linear-gradient(90deg, #10b981, #059669);">Security Audit</span>
                    </a>

                    <a href="#" class="tool-widget">
                        <div class="widget-header">
                            <div class="widget-icon-wrapper" style="background: #3b82f6;">
                                <svg><use href="#icon-code"></use></svg>
                            </div>
                            <h4 class="tool-title">HTML Email Inspector</h4>
                        </div>
                        <p class="tool-description">Professional HTML email debugging with cross-client rendering previews, CSS inliner, and accessibility compliance checker.</p>
                        <span class="tool-badge" style="background: linear-gradient(90deg, #3b82f6, #2563eb);">Development</span>
                    </a>
                </div>
            </section>
        </main>
    </div>
    
    <!-- AI Compliance & Draft Refiner Modal -->
    <div class="modal-overlay" id="ai-tool-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><svg style="width:24px; height:24px; color:var(--secondary-500); margin-right: 8px; vertical-align: middle;"><use href="#icon-sparkle"></use></svg> AI Compliance & Draft Refiner</h3>
                <button class="close-btn" id="close-modal">&times;</button>
            </div>
            
            <!-- Left Side: Input & Controls -->
            <div>
                <div class="input-group">
                    <label for="email-draft">Current Email Draft</label>
                    <textarea id="email-draft" placeholder="Paste your email content here for analysis or refinement."></textarea>
                </div>
                
                <div class="input-group">
                    <label for="tone-select">Refinement Tone</label>
                    <select id="tone-select">
                        <option value="Professional">Professional (Default)</option>
                        <option value="Urgent and Action-Oriented">Urgent and Action-Oriented</option>
                        <option value="Diplomatic and Apologetic">Diplomatic and Apologetic</option>
                        <option value="Concise and Formal Summary">Concise and Formal Summary</option>
                    </select>
                </div>
                
                <div class="flex gap-4">
                    <button class="btn btn-primary flex-grow" id="btn-refine">
                        <svg style="width:18px; height:18px;"><use href="#icon-sparkle"></use></svg> Refine Draft
                    </button>
                    <button class="btn btn-secondary flex-grow" id="btn-compliance">
                        Compliance Check
                    </button>
                </div>
            </div>

            <!-- Right Side: Output -->
            <div>
                <label>AI Output & Report</label>
                <div class="result-panel" id="ai-output">
                    <p class="text-secondary">AI results will appear here after processing.</p>
                </div>
                <div class="loading-indicator hidden mt-4" id="loading-indicator">
                    Processing request... Please wait.
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- Gemini API Configuration & Logic (Unchanged) ---
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const API_KEY = ""; // Canvas will provide this

        /**
         * Generic function to call the Gemini API with exponential backoff.
         */
        async function fetchWithBackoff(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response.json();
                    }
                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.log(`Rate limit exceeded. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    throw new Error(`API call failed with status: ${response.status} ${response.statusText}`);
                } catch (error) {
                    if (i === maxRetries - 1) {
                        console.error("Gemini API Error after all retries:", error);
                        throw new Error("Failed to connect to AI service. Please try again later.");
                    }
                }
            }
        }

        /**
         * Handles both Refine and Compliance requests.
         */
        async function handleGeminiRequest(mode, draft, tone) {
            const outputElement = document.getElementById('ai-output');
            const loadingElement = document.getElementById('loading-indicator');
            const apiKey = typeof __api_key !== 'undefined' ? __api_key : API_KEY;
            const apiUrl = `${API_URL}?key=${apiKey}`;

            if (!draft.trim()) {
                outputElement.innerHTML = "<p style='color: var(--secondary-500);'>Please enter an email draft to process.</p>";
                return;
            }

            loadingElement.classList.remove('hidden');
            outputElement.innerHTML = '';
            
            let systemInstruction;
            let userQuery;

            if (mode === 'compliance') {
                systemInstruction = "You are an Enterprise Compliance Officer AI. Your task is to analyze the user's email draft for PII (Personally Identifiable Information), tone risks, and general GDPR/CCPA compliance issues. Provide a STRICTLY concise, bulleted list report (Max 4 points) with actionable findings. Start with a risk score from 1 to 10 (10 being highest risk).";
                userQuery = `Analyze the following email draft for compliance and risk:\n\n---\n${draft}\n---`;
            } else { // 'refine' mode
                systemInstruction = `You are a professional Corporate Communications Specialist. Rewrite the user's provided email draft to be more ${tone}. Maintain the core message but adjust the tone, vocabulary, and structure to fit the requested style. Only output the rewritten email text.`;
                userQuery = `Rewrite this email: ${draft}`;
            }

            try {
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemInstruction }] },
                };

                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const text = response?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    // Replace newlines with <br> for display
                    outputElement.innerHTML = text.replace(/\n/g, '<br>'); 
                } else {
                    outputElement.innerHTML = "<p style='color: var(--primary-500);'>AI could not generate a valid response.</p>";
                }

            } catch (error) {
                console.error("AI Request Failed:", error);
                outputElement.innerHTML = `<p style='color: var(--primary-500);'>Error: ${error.message}</p>`;
            } finally {
                loadingElement.classList.add('hidden');
            }
        }

        // --- UI / Modal & Theme Logic ---

        document.addEventListener('DOMContentLoaded', () => {
            // Modal Elements
            const modal = document.getElementById('ai-tool-modal');
            const openModalBtn = document.getElementById('open-mailguard-modal');
            const closeModalBtn = document.getElementById('close-modal');
            const draftTextarea = document.getElementById('email-draft');
            const toneSelect = document.getElementById('tone-select');
            const btnRefine = document.getElementById('btn-refine');
            const btnCompliance = document.getElementById('btn-compliance');
            
            // Theme Elements
            const themeRoot = document.getElementById('theme-root');
            const themeOptions = document.querySelectorAll('.theme-option');
            const currentThemeLabel = document.getElementById('current-theme-label');
            const THEMES = ['light', 'dark', 'solaris', 'midnight'];

            // --- Theme Functions ---

            // Function to get initial theme from system preference or default to light
            function getInitialTheme() {
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                return prefersDark ? 'dark' : 'light';
            }

            function setTheme(themeName) {
                if (!THEMES.includes(themeName)) return;

                // 1. Remove all existing theme classes
                THEMES.forEach(theme => themeRoot.classList.remove(theme));
                
                // 2. Add the selected theme class (if not 'light', as 'light' is default/root)
                if (themeName !== 'light') {
                    themeRoot.classList.add(themeName);
                }
                
                // 3. Update active button state
                themeOptions.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-theme') === themeName) {
                        btn.classList.add('active');
                    }
                });

                // 4. Update label
                if(currentThemeLabel) {
                    currentThemeLabel.textContent = `Current: ${themeName.charAt(0).toUpperCase() + themeName.slice(1)}`;
                }
            }

            // --- Initialization ---

            // 1. Set initial theme based on system preference
            const initialTheme = getInitialTheme();
            setTheme(initialTheme);


            // 2. Add event listeners to theme selector buttons
            themeOptions.forEach(button => {
                button.addEventListener('click', () => {
                    const selectedTheme = button.getAttribute('data-theme');
                    setTheme(selectedTheme);
                });
            });

            // --- Modal/AI Logic ---
            
            // Open Modal via Widget Click
            openModalBtn.addEventListener('click', () => {
                modal.classList.add('open');
                // Pre-populate with a sample draft for first-time users
                if (!draftTextarea.value.trim()) {
                    draftTextarea.value = "Hi team, I need to talk to John Doe from marketing about the data breach last week. Can you send me his account ID (JD778) and his home address, 123 Main St, ASAP? This is urgent.";
                }
            });

            // Close Modal
            closeModalBtn.addEventListener('click', () => {
                modal.classList.remove('open');
            });

            // Refine Button Click Handler
            btnRefine.addEventListener('click', () => {
                const draft = draftTextarea.value;
                const tone = toneSelect.value;
                handleGeminiRequest('refine', draft, tone);
            });

            // Compliance Button Click Handler
            btnCompliance.addEventListener('click', () => {
                const draft = draftTextarea.value;
                handleGeminiRequest('compliance', draft, 'N/A'); 
            });
        });
    </script>
</body>
</html>

